<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editing Help - Fish Scale Measurement</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --good-color: #16a34a;
            --warning-color: #ca8a04;
            --danger-color: #dc2626;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        h1 { color: var(--primary-color); margin-bottom: 0.5rem; }
        h2 {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        h3 {
            color: var(--primary-color);
            margin-top: 1.5rem;
        }
        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        code, kbd {
            background: #f1f5f9;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        kbd {
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        a {
            color: var(--primary-color);
        }
        .param-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background: var(--bg-color);
            font-weight: 600;
        }
        .step-list {
            counter-reset: step;
            list-style: none;
            padding-left: 0;
        }
        .step-list li {
            counter-increment: step;
            padding: 0.5rem 0 0.5rem 2.5rem;
            position: relative;
        }
        .step-list li::before {
            content: counter(step);
            position: absolute;
            left: 0;
            width: 1.75rem;
            height: 1.75rem;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 1.75rem;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
        }
        .tip {
            background: #dcfce7;
            border-left: 4px solid var(--good-color);
            padding: 1rem;
            margin: 1rem 0;
        }
        .warning {
            background: #fee2e2;
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin: 1rem 0;
        }
        .mouse-action {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-color);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        .toc {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .toc ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .toc li {
            margin: 0.25rem 0;
        }
    </style>
</head>
<body>
    <a href="javascript:window.close()" class="back-link">Close</a>
    <h1>Editing Reference</h1>
    <p>This guide explains how to manually edit tubercles and connections in the Edit tab.</p>

    <nav class="toc">
        <strong>Contents</strong>
        <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#add-tubercle">Add Tubercle</a></li>
            <li><a href="#add-connection">Add Connection</a></li>
            <li><a href="#add-chain">Chain Mode</a></li>
            <li><a href="#default-diameter">Default Diameter</a></li>
            <li><a href="#move">Move Tubercle</a></li>
            <li><a href="#delete-selected">Delete Selected</a></li>
            <li><a href="#delete-multiple-tub">Delete Multiple Tubercles</a></li>
            <li><a href="#delete-itc">Delete Selected Connection</a></li>
            <li><a href="#delete-multiple-itc">Delete Multiple Connections</a></li>
            <li><a href="#radius">Radius Adjustment</a></li>
            <li><a href="#undo-redo">Undo / Redo</a></li>
            <li><a href="#options">Options</a></li>
            <li><a href="#shortcuts">Keyboard Shortcuts</a></li>
        </ul>
    </nav>

    <h2 id="overview">Overview</h2>

    <div class="section">
        <p>The Edit tab allows you to manually refine the automated tubercle detection results. You can:</p>
        <ul>
            <li><strong>Add</strong> missing tubercles or connections</li>
            <li><strong>Move</strong> incorrectly positioned tubercles</li>
            <li><strong>Resize</strong> tubercles with incorrect diameters</li>
            <li><strong>Delete</strong> false positives or incorrect connections</li>
        </ul>

        <p>All editing operations support <strong>Undo/Redo</strong>, so you can safely experiment without losing work.</p>

        <div class="tip">
            <strong>Tip:</strong> You can also select tubercles and connections by clicking on them directly in the image canvas, regardless of which tab is active.
        </div>

        <h3>Edit Modes</h3>
        <p>Several functions put you into an "edit mode" where clicking on the canvas performs a specific action. The current mode is shown in the status bar at the bottom of the Edit tab. Press <kbd>Escape</kbd> to exit any mode.</p>
    </div>

    <h2 id="add">Adding Elements</h2>

    <div class="section" id="add-tubercle">
        <h3 class="param-name">Add Tubercle</h3>
        <p>Creates a new tubercle at a location you specify by clicking on the image.</p>

        <ol class="step-list">
            <li>Click the <strong>Add Tubercle</strong> button (shows a circle with a + sign)</li>
            <li>The cursor changes to a crosshair and the status shows "Click on image to place tubercle"</li>
            <li>Click anywhere on the image to place a new tubercle at that location</li>
            <li>The tubercle is created with the <a href="#default-diameter">Default Diameter</a> (see below)</li>
            <li>You remain in Add mode to place more tubercles. Press <kbd>Escape</kbd> to exit</li>
        </ol>

        <div class="tip">
            <strong>Tip:</strong> After adding a tubercle, you can adjust its size using the Radius controls while it's still selected.
        </div>
    </div>

    <div class="section" id="add-connection">
        <h3 class="param-name">Add Connection</h3>
        <p>Creates a new connection (edge) between two existing tubercles.</p>

        <ol class="step-list">
            <li>Click the <strong>Add Connection</strong> button (shows two circles with a line)</li>
            <li>The cursor changes to a pointer and the status shows "Click first tubercle"</li>
            <li>Click on the first tubercle you want to connect</li>
            <li>The status changes to "Click second tubercle to create connection"</li>
            <li>Click on the second tubercle to create the connection</li>
            <li>You remain in Add mode to create more connections. Press <kbd>Escape</kbd> to exit</li>
        </ol>

        <div class="note">
            <strong>Note:</strong> You cannot create a duplicate connection between the same two tubercles, and you cannot connect a tubercle to itself.
        </div>
    </div>

    <div class="section" id="add-chain">
        <h3 class="param-name">Chain Mode</h3>
        <p>Chain Mode allows you to add multiple connected tubercles in sequence, which is useful for tracing rows of tubercles.</p>

        <ol class="step-list">
            <li>Click the <strong>Chain Mode</strong> button (shows three connected circles)</li>
            <li>Click on an existing tubercle to start the chain, or click empty space to create a new starting tubercle</li>
            <li>Each subsequent click adds a new tubercle automatically connected to the previous one</li>
            <li>Use arrow keys to navigate between neighbors</li>
            <li>Press <kbd>Escape</kbd> to exit Chain Mode</li>
        </ol>

        <div class="tip">
            <strong>Tip:</strong> Click on any existing tubercle to make it the current node in the chain. This lets you branch off from existing tubercles.
        </div>
    </div>

    <div class="section" id="default-diameter">
        <h3 class="param-name">Default Diameter</h3>
        <p>Controls the diameter (in micrometers) of newly added tubercles.</p>

        <h4>How the Default is Calculated</h4>
        <p>When the field is <strong>empty</strong> (showing "auto"), the diameter for new tubercles is determined as follows:</p>

        <ol class="step-list">
            <li><strong>If tubercles already exist:</strong> Uses the <em>mean diameter</em> of all existing tubercles in the current set</li>
            <li><strong>If no tubercles exist:</strong> Uses a fallback of 10 pixels (converted to µm using calibration)</li>
        </ol>

        <p>The hint text next to the field shows the current auto-calculated value (e.g., "Auto: 4.523 µm").</p>

        <h4>Setting a Custom Diameter</h4>
        <p>Enter a specific value in micrometers to override the automatic calculation. This is useful when:</p>
        <ul>
            <li>You know the expected tubercle size from reference literature</li>
            <li>You want all new tubercles to have a consistent size</li>
            <li>The existing tubercles have highly variable sizes and the mean isn't representative</li>
        </ul>

        <h4>Storage</h4>
        <p>The custom diameter value is saved <strong>per-image</strong> in the annotations file. When you reload the image, your custom value is restored.</p>

        <div class="note">
            <strong>Requires Calibration:</strong> This field is disabled until calibration is set, because the diameter is specified in micrometers which requires knowing the µm/pixel conversion factor.
        </div>

        <div class="tip">
            <strong>Tip:</strong> After adding a tubercle, you can still adjust its individual size using the Radius controls while it's selected.
        </div>
    </div>

    <h2 id="modify-tub">Modifying Tubercles</h2>

    <div class="section" id="move">
        <h3 class="param-name">Move Tubercle</h3>
        <p>Repositions a selected tubercle to a new location.</p>

        <ol class="step-list">
            <li>Select a tubercle by clicking on it in the image</li>
            <li>Click the <strong>Move</strong> button (shows a 4-directional arrow icon)</li>
            <li>The cursor changes to a move cursor and the status shows "Click destination to move selected tubercle"</li>
            <li>Click on the new location for the tubercle</li>
            <li>The tubercle moves to the clicked position. All connected edges are updated automatically</li>
            <li>You remain in Move mode. Press <kbd>Escape</kbd> to exit</li>
        </ol>

        <div class="tip">
            <strong>Tip:</strong> For fine adjustments, use the arrow keys (<kbd>&larr;</kbd> <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <kbd>&rarr;</kbd>) to nudge the selected tubercle by 1 pixel at a time.
        </div>
    </div>

    <div class="section" id="delete-selected">
        <h3 class="param-name">Delete Selected (Tubercle)</h3>
        <p>Deletes the currently selected tubercle.</p>

        <ol class="step-list">
            <li>Select a tubercle by clicking on it in the image</li>
            <li>Click the <strong>Delete Selected</strong> button in the "Modify Tubercle" section</li>
            <li>A confirmation dialog appears (unless disabled in Options)</li>
            <li>Click OK to confirm deletion</li>
        </ol>

        <div class="warning">
            <strong>Important:</strong> Deleting a tubercle also removes all connections attached to it. These can be recovered with Undo.
        </div>

        <p><strong>Keyboard shortcut:</strong> Press <kbd>Delete</kbd> or <kbd>Backspace</kbd> to delete the selected tubercle.</p>
    </div>

    <div class="section" id="delete-multiple-tub">
        <h3 class="param-name">Delete Multiple Tubercles</h3>
        <p>Enters a mode where you can quickly delete multiple tubercles by clicking on them.</p>

        <ol class="step-list">
            <li>First, enable <strong>"Allow delete without confirmation"</strong> in the Options section</li>
            <li>Click the <strong>Delete Multiple</strong> button in the "Modify Tubercle" section</li>
            <li>The cursor changes to a crosshair and the status shows "Click tubercles to delete them"</li>
            <li>Click on any tubercle to delete it immediately (no confirmation dialog)</li>
            <li>Continue clicking to delete more tubercles</li>
            <li>Press <kbd>Escape</kbd> to exit Delete Multiple mode</li>
        </ol>

        <div class="note">
            <strong>Prerequisite:</strong> The "Allow delete without confirmation" checkbox must be enabled for this button to be available. This is a safety feature to prevent accidental deletions.
        </div>
    </div>

    <h2 id="modify-itc">Modifying Connections</h2>

    <div class="section" id="delete-itc">
        <h3 class="param-name">Delete Selected (Connection)</h3>
        <p>Deletes the currently selected connection.</p>

        <ol class="step-list">
            <li>Select a connection by clicking on it in the image (click near the line between two tubercles)</li>
            <li>Click the <strong>Delete Selected</strong> button in the "Modify Connection" section</li>
            <li>A confirmation dialog appears (unless disabled in Options)</li>
            <li>Click OK to confirm deletion</li>
        </ol>

        <p><strong>Keyboard shortcut:</strong> Press <kbd>Delete</kbd> or <kbd>Backspace</kbd> to delete the selected connection.</p>
    </div>

    <div class="section" id="delete-multiple-itc">
        <h3 class="param-name">Delete Multiple Connections</h3>
        <p>Enters a mode where you can quickly delete multiple connections by clicking on them.</p>

        <ol class="step-list">
            <li>First, enable <strong>"Allow delete without confirmation"</strong> in the Options section</li>
            <li>Click the <strong>Delete Multiple</strong> button in the "Modify Connection" section</li>
            <li>The cursor changes to a crosshair and the status shows "Click connections to delete them"</li>
            <li>Click on any connection line to delete it immediately</li>
            <li>Continue clicking to delete more connections</li>
            <li>Press <kbd>Escape</kbd> to exit Delete Multiple mode</li>
        </ol>

        <div class="tip">
            <strong>Tip:</strong> To delete all connections and regenerate them with different settings, use the "Auto Connect" feature in the Extraction tab with a different graph type (Delaunay, Gabriel, or RNG).
        </div>
    </div>

    <h2 id="radius">Radius Adjustment</h2>

    <div class="section" id="radius-controls">
        <h3 class="param-name">Resize Tubercle</h3>
        <p>Adjusts the radius (and therefore diameter) of the selected tubercle.</p>

        <ol class="step-list">
            <li>Select a tubercle by clicking on it in the image</li>
            <li>Use any of these controls:
                <ul>
                    <li><strong>Slider:</strong> Drag to set radius (2-50 pixels)</li>
                    <li><strong>+ / - buttons:</strong> Increase or decrease radius by 1 pixel</li>
                    <li><strong>Arrow keys:</strong> <kbd>&uarr;</kbd> <kbd>&darr;</kbd> to adjust radius by 1 pixel</li>
                </ul>
            </li>
            <li>The diameter in micrometers is calculated automatically using the current calibration</li>
            <li>Connected edge distances are recalculated automatically</li>
        </ol>

        <div class="note">
            <strong>Note:</strong> The minimum radius is 2 pixels. The displayed value shows the radius in pixels. The diameter in micrometers is shown in the Data tab.
        </div>
    </div>

    <h2 id="undo-redo">Undo / Redo</h2>

    <div class="section" id="history">
        <h3 class="param-name">Undo</h3>
        <p>Reverses the last editing operation.</p>
        <p><strong>Keyboard shortcut:</strong> <kbd>Ctrl</kbd>+<kbd>Z</kbd></p>

        <h3 class="param-name">Redo</h3>
        <p>Re-applies an operation that was undone.</p>
        <p><strong>Keyboard shortcut:</strong> <kbd>Ctrl</kbd>+<kbd>Y</kbd></p>

        <p>Operations that can be undone/redone:</p>
        <ul>
            <li>Add tubercle</li>
            <li>Delete tubercle (restores the tubercle and all its connections)</li>
            <li>Move tubercle</li>
            <li>Resize tubercle</li>
            <li>Add connection</li>
            <li>Delete connection</li>
        </ul>

        <div class="tip">
            <strong>Tip:</strong> The Undo/Redo buttons are disabled when there's nothing to undo or redo. The full history is preserved until you load a different image or refresh the page.
        </div>
    </div>

    <h2 id="options">Options</h2>

    <div class="section" id="allow-delete">
        <h3 class="param-name">Allow delete without confirmation</h3>
        <p>When enabled:</p>
        <ul>
            <li>The "Delete Multiple" buttons become available</li>
            <li>Single-item deletions skip the confirmation dialog</li>
        </ul>

        <p>This option is useful when cleaning up many false positives, but be careful - deletions happen immediately when clicked.</p>

        <div class="note">
            <strong>Note:</strong> Even with this option enabled, all deletions can be undone with <kbd>Ctrl</kbd>+<kbd>Z</kbd>.
        </div>
    </div>

    <h2 id="shortcuts">Keyboard Shortcuts</h2>

    <div class="section">
        <table>
            <tr>
                <th>Key</th>
                <th>Action</th>
            </tr>
            <tr>
                <td><kbd>Delete</kbd> / <kbd>Backspace</kbd></td>
                <td>Delete selected tubercle or connection</td>
            </tr>
            <tr>
                <td><kbd>Escape</kbd></td>
                <td>Cancel current mode / Deselect all</td>
            </tr>
            <tr>
                <td><kbd>Tab</kbd></td>
                <td>Cycle through tubercles and connections</td>
            </tr>
            <tr>
                <td><kbd>Ctrl</kbd>+<kbd>Z</kbd></td>
                <td>Undo last operation</td>
            </tr>
            <tr>
                <td><kbd>Ctrl</kbd>+<kbd>Y</kbd></td>
                <td>Redo last undone operation</td>
            </tr>
            <tr>
                <td><kbd>Ctrl</kbd>+<kbd>S</kbd></td>
                <td>Save current annotations</td>
            </tr>
            <tr>
                <td><kbd>&larr;</kbd> <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <kbd>&rarr;</kbd></td>
                <td>Nudge selected tubercle by 1 pixel</td>
            </tr>
            <tr>
                <td><kbd>Ctrl</kbd>+<kbd>N</kbd></td>
                <td>Create new annotation set</td>
            </tr>
            <tr>
                <td><kbd>Ctrl</kbd>+<kbd>1-9</kbd></td>
                <td>Switch to annotation set 1-9</td>
            </tr>
            <tr>
                <td><kbd>F1</kbd> / <kbd>?</kbd></td>
                <td>Show all keyboard shortcuts</td>
            </tr>
        </table>
    </div>

    <h2 id="tips">Best Practices</h2>

    <div class="section">
        <h3>Workflow Recommendations</h3>
        <ol>
            <li><strong>Start with automated extraction:</strong> Run the automatic detection first to get a baseline</li>
            <li><strong>Review the results:</strong> Look for obvious false positives (detected noise) and false negatives (missed tubercles)</li>
            <li><strong>Delete false positives first:</strong> Enable "Allow delete without confirmation" and use Delete Multiple mode</li>
            <li><strong>Add missing tubercles:</strong> Use Add Tubercle mode to fill in obvious gaps</li>
            <li><strong>Adjust positions and sizes:</strong> Fine-tune individual tubercles as needed</li>
            <li><strong>Regenerate connections:</strong> After editing tubercles, use Auto Connect in the Extraction tab to regenerate the neighbor graph</li>
            <li><strong>Save your work:</strong> Press <kbd>Ctrl</kbd>+<kbd>S</kbd> or use the Save button in the Extraction tab</li>
        </ol>

        <div class="tip">
            <strong>Tip:</strong> Create multiple annotation sets to compare different editing approaches or parameter settings. Use <kbd>Ctrl</kbd>+<kbd>N</kbd> to create a new set.
        </div>
    </div>
</body>
</html>
