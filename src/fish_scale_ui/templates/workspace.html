{% extends "base.html" %}

{% block title %}Fish Scale Measurement - Workspace{% endblock %}

{% block content %}
<div class="workspace">
    <!-- Left Panel: Image Display -->
    <div class="image-panel">
        <div class="image-container" id="imageContainer">
            <div class="image-wrapper" id="imageWrapper">
                <img id="mainImage" src="" alt="Main Image" style="display: none;">
                <canvas id="overlayCanvas"></canvas>
            </div>
        </div>

        <!-- Statistics bar (always visible, first row under image) -->
        <div class="stats-bar" id="statsBar">
            <span class="stats-bar-set-name" id="statsBarSetName">Base</span>
            <div class="stats-bar-item">
                <span class="stats-bar-label">TUB:</span>
                <span id="statsBarTubercles" class="stats-bar-value">-</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">Ø:</span>
                <span id="statsBarDiameter" class="stats-bar-value">-</span>
                <span class="stats-bar-unit">µm</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">ITC:</span>
                <span id="statsBarEdges" class="stats-bar-value">-</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">Space:</span>
                <span id="statsBarSpace" class="stats-bar-value">-</span>
                <span class="stats-bar-unit">µm</span>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="image-toolbar">
            <button type="button" class="btn btn-secondary" id="newImageBtn" title="Load new image">
                New Image
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" class="btn btn-icon" id="zoomInBtn" title="Zoom in (+)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button type="button" class="btn btn-icon" id="zoomOutBtn" title="Zoom out (-)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button type="button" class="btn btn-icon" id="zoomFitBtn" title="Zoom to fit (0)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <span class="zoom-level" id="zoomLevel">100%</span>
        </div>

        <!-- Overlay toggle controls -->
        <div class="overlay-toggles">
            <label class="overlay-toggle" title="Show/hide tubercle ID numbers">
                <input type="checkbox" id="toggleNumbers">
                <span>Numbers</span>
            </label>
            <label class="overlay-toggle" title="Show/hide tubercle circles">
                <input type="checkbox" id="toggleTubes" checked>
                <span>Tubes</span>
            </label>
            <label class="overlay-toggle" title="Show/hide connection lines">
                <input type="checkbox" id="toggleLinks" checked>
                <span>Links</span>
            </label>
            <label class="overlay-toggle" title="Show/hide calibration scale">
                <input type="checkbox" id="toggleScale">
                <span>Scale</span>
            </label>
        </div>

        <!-- Set selector bar -->
        <div class="set-selector-bar" id="setSelector">
            <div class="set-buttons" id="setButtons">
                <!-- Set buttons will be populated by JavaScript -->
            </div>
            <div class="set-actions">
                <button type="button" class="btn btn-icon btn-sm" id="addSetBtn" title="Create new set (Ctrl+N)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                </button>
                <button type="button" class="btn btn-sm" id="saveSetBtn" title="Save all sets (Ctrl+S)" disabled>
                    Save
                </button>
                <button type="button" class="btn btn-icon btn-sm" id="shortcutsHelpBtn" title="Keyboard shortcuts">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h8"/>
                    </svg>
                </button>
                <div class="set-menu-container">
                    <button type="button" class="btn btn-icon btn-sm" id="setMenuBtn" title="Set management">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <div class="set-menu-dropdown" id="setMenuDropdown" style="display: none;">
                        <button class="set-menu-item" id="renameSetBtn">Rename Set...</button>
                        <button class="set-menu-item" id="duplicateSetBtn">Duplicate Set...</button>
                        <hr class="set-menu-divider">
                        <button class="set-menu-item set-menu-danger" id="deleteSetBtn">Delete Set</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Resizer -->
    <div class="panel-resizer" id="panelResizer"></div>

    <!-- Right Panel: Tabs -->
    <div class="tabs-panel" id="tabsPanel">
        <div class="tab-headers">
            <button class="tab-header active" data-tab="image">Image</button>
            <button class="tab-header" data-tab="calibration">Calibration</button>
            <button class="tab-header" data-tab="extraction">Extraction</button>
            <button class="tab-header" data-tab="configure">Configure</button>
            <button class="tab-header" data-tab="edit">Edit</button>
            <button class="tab-header" data-tab="data">Data</button>
            <button class="tab-header" data-tab="log">Log</button>
            <button class="tab-header" data-tab="settings">Settings</button>
            <button class="tab-header" data-tab="about">About</button>
        </div>

        <div class="tab-content">
            <!-- Image Tab -->
            <div class="tab-pane active" data-tab="image">
                <h2>Image</h2>
                <p class="tab-description">Rotate, crop, and save your image.</p>

                <div class="image-tab-section">
                    <h3>Rotation</h3>
                    <div class="image-action-buttons">
                        <button type="button" class="btn btn-secondary" id="rotateLeftBtnTab" title="Rotate left 90 degrees">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 4v6h6"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Rotate Left
                        </button>
                        <button type="button" class="btn btn-secondary" id="rotateRightBtnTab" title="Rotate right 90 degrees">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Rotate Right
                        </button>
                    </div>
                </div>

                <div class="image-tab-section">
                    <h3>Crop</h3>
                    <p class="hint">Select an area of the image to keep.</p>
                    <div class="crop-controls">
                        <button type="button" class="btn btn-secondary" id="cropBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2v4H2v14h14v-4h4V2H6z"/>
                                <path d="M6 6h8v8"/>
                            </svg>
                            Start Crop
                        </button>
                        <span id="cropStatus" class="crop-status"></span>
                    </div>
                    <div class="crop-action-buttons" id="cropActionButtons" style="display: none;">
                        <button type="button" class="btn btn-primary btn-sm" id="cropConfirmBtn">Apply Crop</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cropCancelBtn">Cancel</button>
                    </div>
                    <div class="autocrop-controls">
                        <button type="button" class="btn btn-secondary" id="autocropBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M9 9h6v6H9z"/>
                            </svg>
                            Autocrop
                        </button>
                        <span class="hint" style="margin-left: 0.5rem;">Remove empty borders</span>
                    </div>
                </div>

                <div class="image-tab-section save-section">
                    <h3>Save</h3>
                    <div class="save-controls">
                        <button type="button" class="btn btn-primary" id="saveSloBtn">
                            Save SLO
                        </button>
                        <span id="unsavedIndicatorImage" class="unsaved-indicator" style="display: none;">Unsaved</span>
                    </div>
                    <p class="hint">Save tubercle and connection data to SLO files.</p>
                </div>
            </div>

            <!-- Calibration Tab -->
            <div class="tab-pane" data-tab="calibration">
                <h2>Calibration</h2>
                <p class="tab-description">Set the scale for measurements.</p>

                <div class="calibration-display-section">
                    <h3>Current Calibration</h3>
                    <div class="calibration-display">
                        <span id="calibrationValue">Not set</span>
                        <span id="calibrationWarning" class="warning-badge" style="display: none;">Auto-estimated</span>
                    </div>
                </div>

                <div class="calibration-section-header">Automatic Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Auto-Estimate</h3>
                    <p class="hint">Use estimated calibration based on 700x magnification (~0.14 µm/pixel).</p>
                    <div class="estimate-controls">
                        <button type="button" class="btn btn-secondary" id="applyEstimateBtn">Apply Estimate</button>
                    </div>
                </div>

                <div class="calibration-section-header">Manual Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Scale Bar Measurement</h3>
                    <p class="hint">Enter the known length of a scale bar.</p>
                    <div class="calibration-inputs">
                        <input type="number" id="scaleUm" placeholder="µm" min="0" step="0.1">
                        <span>=</span>
                        <input type="number" id="scalePx" placeholder="pixels" min="1" step="1">
                        <button type="button" class="btn btn-sm btn-primary" id="applyCalibrationBtn">Apply</button>
                    </div>
                </div>

                <div class="calibration-method-section">
                    <h3>Direct Input</h3>
                    <p class="hint">Enter the calibration value directly.</p>
                    <div class="calibration-inputs">
                        <input type="number" id="umPerPx" placeholder="µm/pixel" min="0" step="0.001">
                        <button type="button" class="btn btn-sm btn-primary" id="applyDirectBtn">Apply</button>
                    </div>
                </div>

                <div class="calibration-section-header">Graphical Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Measure on Image</h3>
                    <p class="hint">Draw a line on a known scale bar in the image.</p>
                    <div class="measure-controls">
                        <button type="button" class="btn btn-secondary" id="measureScaleBtn">Manually Draw Scale Bar</button>
                        <span id="measureStatus" class="measure-status"></span>
                    </div>
                </div>
            </div>

            <!-- Extraction Tab -->
            <div class="tab-pane" data-tab="extraction">
                <h2>Extraction <span id="unsavedIndicator" class="unsaved-indicator" style="display: none;">Unsaved</span></h2>
                <p class="tab-description">Extract tubercles and intertubercular connections from the image.</p>

                <div class="extraction-actions">
                    <button type="button" class="btn btn-primary" id="extractBtn">
                        Extract Tubercles and Connections
                    </button>
                    <span class="spinner" id="extractSpinner" style="display: none;"></span>
                    <span id="paramsChangedIndicator" class="params-changed-indicator" style="display: none;">
                        Parameters changed
                    </span>
                </div>

                <div class="extraction-info">
                    <p class="hint">Configure detection parameters in the Configure tab before extraction.</p>
                </div>

                <div class="slo-actions">
                    <h3>SLO Files</h3>
                    <button type="button" class="btn btn-secondary btn-sm" id="loadSloBtn">Load Existing SLO</button>
                </div>
            </div>

            <!-- Configure Tab -->
            <div class="tab-pane" data-tab="configure">
                <h2>Configure</h2>

                <div class="config-section">
                    <h3>Profile Presets</h3>
                    <select id="profileSelect" class="param-select">
                        <option value="">-- Select Profile --</option>
                    </select>
                </div>

                <div class="config-section">
                    <h3>Detection Parameters</h3>

                    <div class="param-row">
                        <label for="method">
                            Method
                            <a href="#" class="help-icon" data-param="method" title="Help">?</a>
                        </label>
                        <select id="method" class="param-input param-select">
                            <option value="log">LoG (Laplacian of Gaussian)</option>
                            <option value="dog">DoG (Difference of Gaussian)</option>
                            <option value="ellipse">Ellipse Fitting</option>
                            <option value="lattice">Lattice-aware</option>
                        </select>
                    </div>

                    <div class="param-row">
                        <label for="threshold">
                            Threshold
                            <a href="#" class="help-icon" data-param="threshold" title="Help">?</a>
                        </label>
                        <input type="range" id="threshold" class="param-input param-range"
                               min="0.01" max="0.50" step="0.01" value="0.05">
                        <span id="threshold_value" class="param-value">0.05</span>
                    </div>

                    <div class="param-row">
                        <label for="min_diameter_um">
                            Min Diameter (um)
                            <a href="#" class="help-icon" data-param="min-diameter" title="Help">?</a>
                        </label>
                        <input type="number" id="min_diameter_um" class="param-input param-number"
                               min="0.5" max="20" step="0.5" value="2.0">
                    </div>

                    <div class="param-row">
                        <label for="max_diameter_um">
                            Max Diameter (um)
                            <a href="#" class="help-icon" data-param="max-diameter" title="Help">?</a>
                        </label>
                        <input type="number" id="max_diameter_um" class="param-input param-number"
                               min="1" max="50" step="0.5" value="10.0">
                    </div>

                    <div class="param-row">
                        <label for="min_circularity">
                            Circularity
                            <a href="#" class="help-icon" data-param="circularity" title="Help">?</a>
                        </label>
                        <input type="range" id="min_circularity" class="param-input param-range"
                               min="0" max="1" step="0.05" value="0.5">
                        <span id="min_circularity_value" class="param-value">0.5</span>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Preprocessing</h3>

                    <div class="param-row">
                        <label for="clahe_clip">
                            CLAHE Clip
                            <a href="#" class="help-icon" data-param="clahe-clip" title="Help">?</a>
                        </label>
                        <input type="range" id="clahe_clip" class="param-input param-range"
                               min="0.01" max="0.20" step="0.01" value="0.03">
                        <span id="clahe_clip_value" class="param-value">0.03</span>
                    </div>

                    <div class="param-row">
                        <label for="clahe_kernel">
                            CLAHE Kernel
                            <a href="#" class="help-icon" data-param="clahe-kernel" title="Help">?</a>
                        </label>
                        <input type="number" id="clahe_kernel" class="param-input param-number"
                               min="4" max="32" step="2" value="8">
                    </div>

                    <div class="param-row">
                        <label for="blur_sigma">
                            Blur Sigma
                            <a href="#" class="help-icon" data-param="blur-sigma" title="Help">?</a>
                        </label>
                        <input type="range" id="blur_sigma" class="param-input param-range"
                               min="0" max="5" step="0.1" value="1.0">
                        <span id="blur_sigma_value" class="param-value">1.0</span>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Neighbor Graph</h3>

                    <div class="param-row">
                        <label for="neighbor_graph">
                            Graph Type
                            <a href="#" class="help-icon" data-param="neighbor-graph-type" title="Help">?</a>
                        </label>
                        <select id="neighbor_graph" class="param-input param-select">
                            <option value="delaunay">Delaunay</option>
                            <option value="gabriel">Gabriel</option>
                            <option value="rng">RNG (Recommended)</option>
                        </select>
                    </div>
                </div>

                <div class="config-actions">
                    <button type="button" class="btn btn-secondary btn-sm" id="resetParamsBtn">Reset to Defaults</button>
                </div>
            </div>

            <!-- Edit Tab -->
            <div class="tab-pane" data-tab="edit">
                <h2>Edit</h2>
                <p class="tab-description">Manually edit tubercles and connections.</p>

                <div class="edit-section">
                    <h3>Add</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="addTubBtn" title="Add new tubercle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Tubercle
                        </button>
                        <button type="button" class="btn btn-secondary" id="addItcBtn" title="Add connection between tubercles">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="12" r="3"/>
                                <line x1="9" y1="12" x2="15" y2="12"/>
                            </svg>
                            Add Connection
                        </button>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Modify Tubercle</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="moveBtn" disabled title="Move selected tubercle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="5 9 2 12 5 15"/>
                                <polyline points="9 5 12 2 15 5"/>
                                <polyline points="15 19 12 22 9 19"/>
                                <polyline points="19 9 22 12 19 15"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <line x1="12" y1="2" x2="12" y2="22"/>
                            </svg>
                            Move
                        </button>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteTubBtn" disabled title="Delete selected tubercle (Del)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Selected
                        </button>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteMultipleTubBtn" disabled title="Click tubercles to delete them (requires 'Allow delete without confirmation')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Multiple
                        </button>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Modify Connection</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteItcBtn" disabled title="Delete selected connection (Del)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Selected
                        </button>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteMultipleItcBtn" disabled title="Click connections to delete them (requires 'Allow delete without confirmation')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Multiple
                        </button>
                    </div>
                </div>

                <div class="edit-section" id="radiusControls">
                    <h3>Radius Adjustment</h3>
                    <p class="hint" id="radiusHintSelect">Select a tubercle to resize</p>
                    <div class="radius-controls" id="radiusControlsInner">
                        <button type="button" class="btn btn-icon btn-sm" id="radiusDecBtn" title="Decrease radius" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <input type="range" id="radiusSlider" min="2" max="50" step="0.5" value="10" disabled>
                        <button type="button" class="btn btn-icon btn-sm" id="radiusIncBtn" title="Increase radius" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <span id="radiusValue" class="radius-value">10.0px</span>
                    </div>
                    <p class="hint" id="radiusHintUsage" style="display: none;">Use slider or +/- buttons. Arrow keys nudge by 1px.</p>
                </div>

                <div class="edit-section">
                    <h3>History</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="undoBtn" disabled title="Undo (Ctrl+Z)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v6h6"/>
                                <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                            </svg>
                            Undo
                        </button>
                        <button type="button" class="btn btn-secondary" id="redoBtn" disabled title="Redo (Ctrl+Y)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 7v6h-6"/>
                                <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
                            </svg>
                            Redo
                        </button>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Options</h3>
                    <div class="setting-item">
                        <label class="setting-label">
                            <input type="checkbox" id="allowDeleteWithoutConfirm">
                            <span>Allow delete without confirmation</span>
                        </label>
                    </div>
                </div>

                <div class="edit-status-section">
                    <span id="editStatus" class="edit-status"></span>
                </div>

                <div class="edit-shortcuts">
                    <h3>Keyboard Shortcuts</h3>
                    <table class="shortcuts-table">
                        <tr><td><kbd>F1</kbd> or <kbd>?</kbd></td><td>Show all shortcuts</td></tr>
                        <tr><td><kbd>Delete</kbd></td><td>Delete selected</td></tr>
                        <tr><td><kbd>Escape</kbd></td><td>Cancel / Deselect</td></tr>
                        <tr><td><kbd>Tab</kbd></td><td>Cycle selection</td></tr>
                        <tr><td><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
                        <tr><td><kbd>Ctrl+Y</kbd></td><td>Redo</td></tr>
                        <tr><td><kbd>Ctrl+S</kbd></td><td>Save SLO</td></tr>
                        <tr><td><kbd>Ctrl+N</kbd></td><td>New set</td></tr>
                        <tr><td><kbd>Ctrl+1-9</kbd></td><td>Switch to set</td></tr>
                        <tr><td><kbd>Arrow keys</kbd></td><td>Nudge 1px</td></tr>
                    </table>
                </div>
            </div>

            <!-- Data Tab -->
            <div class="tab-pane" data-tab="data">
                <h2>Data</h2>

                <div class="data-section">
                    <h3>Statistics</h3>
                    <div id="statisticsPanel" class="statistics-panel">
                        <div class="stat-row">
                            <span class="stat-label">Tubercles:</span>
                            <span id="statNTubercles" class="stat-value">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mean Diameter:</span>
                            <span id="statMeanDiameter" class="stat-value">-</span>
                            <span class="stat-unit">um</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Connections:</span>
                            <span id="statNEdges" class="stat-value">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mean Space:</span>
                            <span id="statMeanSpace" class="stat-value">-</span>
                            <span class="stat-unit">um</span>
                        </div>
                        <div class="stat-row classification">
                            <span class="stat-label">Classification:</span>
                            <span id="statGenus" class="stat-value">-</span>
                            <span id="statConfidence" class="stat-confidence">-</span>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <h3>Tubercles (TUB)</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="tubTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Diam (um)</th>
                                    <th>Circ</th>
                                </tr>
                            </thead>
                            <tbody id="tubTableBody">
                                <tr><td colspan="5" class="empty-table">No tubercles detected</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="data-section">
                    <h3>Intertubercular Connections (ITC)</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="itcTable">
                            <thead>
                                <tr>
                                    <th>ID1</th>
                                    <th>ID2</th>
                                    <th>Center (um)</th>
                                    <th>Edge (um)</th>
                                </tr>
                            </thead>
                            <tbody id="itcTableBody">
                                <tr><td colspan="4" class="empty-table">No connections detected</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Log Tab -->
            <div class="tab-pane" data-tab="log">
                <h2>Log</h2>
                <div class="log-container">
                    <table class="log-table" id="logTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Event</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane" data-tab="settings">
                <h2>Settings</h2>
                <div class="settings-content">
                    <!-- Navigation Settings -->
                    <div class="settings-group" id="settingsNavigation">
                        <div class="settings-group-header">
                            <h3>Navigation</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="scrollWheelZoom" checked>
                                    <span>Enable scroll wheel zoom</span>
                                </label>
                                <p class="setting-hint">When disabled, use the zoom buttons or keyboard shortcuts (+/-) instead.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Overlay Display Settings -->
                    <div class="settings-group" id="settingsOverlay">
                        <div class="settings-group-header">
                            <h3>Overlay Display</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="showTubercleIds">
                                    <span>Show tubercle IDs</span>
                                </label>
                                <p class="setting-hint">Display ID numbers on each detected tubercle.</p>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">ID text size</label>
                                <div class="range-with-value">
                                    <input type="range" id="idTextSize" min="8" max="24" step="1" value="12">
                                    <span class="range-value" id="idTextSizeValue">12px</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Tubercle color</label>
                                <div class="color-input-row">
                                    <input type="color" id="tubercleColorPicker" value="#00ffff">
                                    <input type="text" id="tubercleColorText" value="#00ffff" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Connection color</label>
                                <div class="color-input-row">
                                    <input type="color" id="connectionColorPicker" value="#ffff00">
                                    <input type="text" id="connectionColorText" value="#ffff00" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Connection endpoints</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="connectionEndpoint" id="connectionToCenter" value="center" checked>
                                        <span>Draw to tubercle center</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="connectionEndpoint" id="connectionToEdge" value="edge">
                                        <span>Draw to tubercle edge</span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item setting-divider">
                                <label class="setting-label">
                                    <input type="checkbox" id="showCalibrationScale">
                                    <span>Show calibration scale</span>
                                </label>
                                <p class="setting-hint">Display a labeled scale bar on the image.</p>
                            </div>

                            <div class="setting-item" id="scalePositionSetting">
                                <label class="setting-label-text">Scale position</label>
                                <select id="scalePosition" class="setting-select">
                                    <option value="top-left">Top-Left</option>
                                    <option value="top-center">Top-Center</option>
                                    <option value="top-right">Top-Right</option>
                                    <option value="middle-left">Middle-Left</option>
                                    <option value="middle-right">Middle-Right</option>
                                    <option value="bottom-left" selected>Bottom-Left</option>
                                    <option value="bottom-center">Bottom-Center</option>
                                    <option value="bottom-right">Bottom-Right</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Future Settings Placeholder -->
                    <div class="settings-group collapsed" id="settingsAdvanced">
                        <div class="settings-group-header">
                            <h3>Advanced</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <p class="setting-hint">Advanced settings will appear here in future updates.</p>
                            </div>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button type="button" class="btn btn-secondary" id="resetSettingsBtn">Reset to Defaults</button>
                    </div>
                </div>
            </div>

            <!-- About Tab -->
            <div class="tab-pane" data-tab="about">
                <h2>About</h2>
                <div class="about-content">
                    <h3>Fish Scale Measurement</h3>
                    <p>Tubercle diameter and intertubercular space extraction from SEM images of ganoid fish scales.</p>

                    <table class="about-table">
                        <tr>
                            <td>Application Version</td>
                            <td>{{ version_info.app_version }}</td>
                        </tr>
                        <tr>
                            <td>Python Version</td>
                            <td>{{ version_info.python_version }}</td>
                        </tr>
                        <tr>
                            <td>NumPy</td>
                            <td>{{ version_info.numpy_version }}</td>
                        </tr>
                        <tr>
                            <td>SciPy</td>
                            <td>{{ version_info.scipy_version }}</td>
                        </tr>
                        <tr>
                            <td>scikit-image</td>
                            <td>{{ version_info.skimage_version }}</td>
                        </tr>
                        <tr>
                            <td>Flask</td>
                            <td>{{ version_info.flask_version }}</td>
                        </tr>
                        <tr>
                            <td>Git Commit</td>
                            <td>{{ version_info.git_hash }}</td>
                        </tr>
                        <tr>
                            <td>Build Date</td>
                            <td>{{ version_info.git_date }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal for prompts -->
<div class="modal-overlay" id="modalOverlay" style="display: none;">
    <div class="modal" id="modal">
        <div class="modal-header" id="modalHeader">Prompt</div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- Toast notifications -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/sets.js') }}"></script>
<script src="{{ url_for('static', filename='js/image.js') }}"></script>
<script src="{{ url_for('static', filename='js/calibration.js') }}"></script>
<script src="{{ url_for('static', filename='js/configure.js') }}"></script>
<script src="{{ url_for('static', filename='js/overlay.js') }}"></script>
<script src="{{ url_for('static', filename='js/data.js') }}"></script>
<script src="{{ url_for('static', filename='js/undo.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/extraction.js') }}"></script>
<script src="{{ url_for('static', filename='js/setUI.js') }}"></script>
<script>
    // MCP state polling for auto-refresh
    let mcpPollingEnabled = true;
    let lastStateHash = null;
    let currentImageUrl = null;

    function computeStateHash(state) {
        // Simple hash based on counts and image filename
        const tubCount = (state.tubercles || []).length;
        const edgeCount = (state.edges || []).length;
        const debugCount = (state.debug_shapes || []).length;
        const imgName = state.image?.filename || '';
        return `${imgName}:${tubCount}:${edgeCount}:${debugCount}`;
    }

    async function pollMCPState() {
        if (!mcpPollingEnabled) return;

        try {
            const response = await fetch('/api/mcp/state');
            const state = await response.json();
            const newHash = computeStateHash(state);

            // Check if state changed
            if (newHash !== lastStateHash) {
                console.log('MCP state changed:', lastStateHash, '->', newHash);
                lastStateHash = newHash;

                // Load image if changed or not loaded
                if (state.image?.loaded && state.image?.filename) {
                    const imgResponse = await fetch('/api/current-image');
                    const imgData = await imgResponse.json();

                    if (imgData.web_url && imgData.web_url !== currentImageUrl) {
                        currentImageUrl = imgData.web_url;
                        window.imageViewer.loadImage(currentImageUrl);
                        // Wait for image to load before setting overlay
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    // Update overlay data (including debug shapes)
                    window.overlay.setData(state.tubercles || [], state.edges || [], state.debug_shapes || []);

                    // Update calibration
                    if (state.calibration?.um_per_px) {
                        window.calibration?.setCalibration(state.calibration.um_per_px, state.calibration.method || 'mcp');
                    }

                    // Fetch and update statistics (computed on-the-fly)
                    try {
                        const statsResponse = await fetch('/api/mcp/statistics');
                        const stats = await statsResponse.json();
                        updateStatisticsDisplay(stats);
                    } catch (e) {
                        console.log('Failed to fetch statistics:', e);
                    }

                    // Refresh data panel
                    window.dataPanel?.refresh();
                }
            }
        } catch (e) {
            // Silently ignore polling errors
        }

        // Schedule next poll (2 seconds)
        setTimeout(pollMCPState, 2000);
    }

    function updateStatisticsDisplay(stats) {
        // Update the statistics panel elements
        const panelElements = {
            'statNTubercles': stats.n_tubercles,
            'statNEdges': stats.n_edges,
            'statMeanDiameter': stats.mean_diameter_um?.toFixed(2),
            'statMeanSpace': stats.mean_space_um?.toFixed(2),
            'statGenus': stats.suggested_genus,
            'statConfidence': stats.classification_confidence,
        };

        // Update the stats bar elements
        const barElements = {
            'statsBarTubercles': stats.n_tubercles,
            'statsBarEdges': stats.n_edges,
            'statsBarDiameter': stats.mean_diameter_um?.toFixed(2),
            'statsBarSpace': stats.mean_space_um?.toFixed(2),
        };

        for (const [id, value] of Object.entries({...panelElements, ...barElements})) {
            const el = document.getElementById(id);
            if (el && value !== undefined) {
                el.textContent = value ?? '-';
            }
        }
    }

    // Initialize workspace when DOM is ready
    document.addEventListener('DOMContentLoaded', async function() {
        // Get image URL from query params
        const params = new URLSearchParams(window.location.search);
        let imgUrl = params.get('img');

        // If no URL param, check if MCP API has loaded an image
        if (!imgUrl) {
            try {
                const response = await fetch('/api/mcp/state');
                const state = await response.json();
                lastStateHash = computeStateHash(state);

                if (state.image && state.image.loaded && state.image.filename) {
                    // Get the web path from current-image endpoint
                    const imgResponse = await fetch('/api/current-image');
                    const imgData = await imgResponse.json();
                    if (imgData.web_url) {
                        imgUrl = imgData.web_url;
                        currentImageUrl = imgUrl;
                        // Also load any existing extraction data
                        if (state.tubercles && state.tubercles.length > 0) {
                            // Wait for image to load, then set overlay data
                            window.imageViewer.loadImage(imgUrl);
                            setTimeout(async () => {
                                window.overlay.setData(state.tubercles, state.edges || []);
                                if (state.calibration) {
                                    window.calibration.setCalibration(state.calibration.um_per_px, state.calibration.method || 'mcp');
                                }
                                // Fetch statistics (computed on-the-fly)
                                try {
                                    const statsResponse = await fetch('/api/mcp/statistics');
                                    const stats = await statsResponse.json();
                                    updateStatisticsDisplay(stats);
                                } catch (e) {
                                    console.log('Failed to fetch statistics:', e);
                                }
                                window.dataPanel?.refresh();
                            }, 500);
                            window.app.loadLog();
                            // Start polling for MCP changes
                            setTimeout(pollMCPState, 2000);
                            return;
                        }
                    }
                }
            } catch (e) {
                console.log('No MCP state available:', e);
            }
        }

        if (imgUrl) {
            currentImageUrl = imgUrl;
            window.imageViewer.loadImage(imgUrl);
        }

        // Load initial log
        window.app.loadLog();

        // Start polling for MCP changes (even if loaded via URL param)
        setTimeout(pollMCPState, 2000);
    });
</script>
{% endblock %}
