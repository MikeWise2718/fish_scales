{% extends "base.html" %}

{% block title %}Fish Scale Measurement - Workspace{% endblock %}

{% block content %}
<div class="workspace">
    <!-- Left Panel: Image Display -->
    <div class="image-panel">
        <!-- Edit Mode Banner - shows when edit mode is active -->
        <div class="edit-mode-banner" id="editModeBanner" style="display: none;">
            <div class="edit-mode-banner-content">
                <span class="edit-mode-banner-icon" id="editModeBannerIcon"></span>
                <div class="edit-mode-banner-text">
                    <span class="edit-mode-banner-title" id="editModeBannerTitle"></span>
                    <span class="edit-mode-banner-desc" id="editModeBannerDesc"></span>
                </div>
            </div>
            <button type="button" class="edit-mode-banner-exit" id="editModeBannerExit" title="Exit mode (Esc)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="image-container" id="imageContainer">
            <div class="image-wrapper" id="imageWrapper">
                <img id="mainImage" src="" alt="Main Image" style="display: none;">
                <canvas id="overlayCanvas"></canvas>
            </div>
        </div>

        <!-- Statistics bar (always visible, first row under image) -->
        <div class="stats-bar" id="statsBar">
            <span class="stats-bar-set-label">Set:</span>
            <button type="button" class="btn btn-xs btn-icon stats-bar-set-nav" id="prevSetBtn" title="Previous set">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div class="stats-bar-set-dropdown" id="statsBarSetDropdown">
                <button type="button" class="stats-bar-set-btn" id="statsBarSetBtn">
                    <span id="statsBarSetName">Base</span>
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="stats-bar-set-menu" id="statsBarSetMenu" style="display: none;">
                    <!-- Set list populated by JavaScript -->
                </div>
            </div>
            <button type="button" class="btn btn-xs btn-icon stats-bar-set-nav" id="nextSetBtn" title="Next set">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <button type="button" class="btn btn-xs btn-secondary stats-bar-new-set" id="statsBarNewSetBtn" title="Create new set">+ New</button>
            <button type="button" class="btn btn-xs btn-secondary" id="saveSetBtn" title="Save all sets (Ctrl+S)" disabled>Save</button>
            <button type="button" class="btn btn-xs btn-secondary" id="saveAsBtn" title="Save with custom filename" disabled>Save As...</button>
            <div class="stats-bar-gear-container">
                <button type="button" class="btn btn-xs btn-icon" id="setMenuBtn" title="Set management">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <div class="stats-bar-gear-menu" id="setMenuDropdown" style="display: none;">
                    <button class="stats-bar-gear-item" id="renameSetBtn">Rename Set...</button>
                    <button class="stats-bar-gear-item" id="duplicateSetBtn">Duplicate Set...</button>
                    <hr class="stats-bar-gear-divider">
                    <button class="stats-bar-gear-item stats-bar-gear-danger" id="deleteSetBtn">Delete Set</button>
                </div>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">TUB:</span>
                <span id="statsBarTubercles" class="stats-bar-value">-</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">Ø:</span>
                <span id="statsBarDiameter" class="stats-bar-value">-</span>
                <span class="stats-bar-unit">µm</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">ITC:</span>
                <span id="statsBarEdges" class="stats-bar-value">-</span>
            </div>
            <div class="stats-bar-item">
                <span class="stats-bar-label">Space:</span>
                <span id="statsBarSpace" class="stats-bar-value">-</span>
                <span class="stats-bar-unit">µm</span>
            </div>
            <div class="stats-bar-item stats-bar-hex">
                <span class="stats-bar-label">Hex:</span>
                <span id="statsBarHex" class="stats-bar-value stats-bar-hex-value">-</span>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="image-toolbar">
            <button type="button" class="btn btn-secondary" id="newImageBtn" title="Load new image">
                New Image
            </button>
            <span class="toolbar-filename" id="toolbarFilename" title="Current image filename">No image loaded</span>
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn btn-icon" id="zoomInBtn" title="Zoom in (+)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button type="button" class="btn btn-icon" id="zoomOutBtn" title="Zoom out (-)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button type="button" class="btn btn-icon" id="zoomFitBtn" title="Zoom to fit (0)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <div class="toolbar-separator"></div>
            <button type="button" class="btn btn-icon" id="shortcutsHelpBtn" title="Keyboard shortcuts">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                    <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h8"/>
                </svg>
            </button>
        </div>

        <!-- Overlay toggle controls -->
        <div class="overlay-toggles">
            <label class="overlay-toggle" title="Show/hide tubercle ID numbers">
                <input type="checkbox" id="toggleNumbers">
                <span>Tube IDs</span>
            </label>
            <label class="overlay-toggle" title="Show/hide tubercle circles">
                <input type="checkbox" id="toggleTubes" checked>
                <span>Tubes</span>
            </label>
            <label class="overlay-toggle" title="Show/hide ITC ID numbers">
                <input type="checkbox" id="toggleItcIds">
                <span>ITC IDs</span>
            </label>
            <label class="overlay-toggle" title="Show/hide ITC connection lines">
                <input type="checkbox" id="toggleLinks" checked>
                <span>ITCs</span>
            </label>
            <label class="overlay-toggle" title="Show/hide calibration scale">
                <input type="checkbox" id="toggleScale">
                <span>Scale</span>
            </label>
            <label class="overlay-toggle" title="Show/hide coordinate grid">
                <input type="checkbox" id="toggleGrid">
                <span>Grid</span>
            </label>
            <label class="overlay-toggle" title="Show fitted ellipses instead of circles">
                <input type="checkbox" id="showEllipses">
                <span>Ellipses</span>
            </label>
        </div>

    </div>

    <!-- Panel Resizer -->
    <div class="panel-resizer" id="panelResizer"></div>

    <!-- Right Panel: Tabs -->
    <div class="tabs-panel" id="tabsPanel">
        <div class="panel-header-row">
            <span class="current-filename" id="currentFilename" title="Current image filename">No image loaded</span>
            <div class="panel-header-controls">
                <!-- Controls can be added here on the far right -->
            </div>
        </div>
        <div class="tab-headers">
            <button class="tab-header active" data-tab="image">Image</button>
            <button class="tab-header" data-tab="calibration">Calibration</button>
            <button class="tab-header" data-tab="extraction">Extraction</button>
            {% if agent_tabs.extraction %}
            <button class="tab-header" data-tab="agent-extraction">AgenticExtraction</button>
            {% endif %}
            <button class="tab-header" data-tab="edit">Edit</button>
            {% if agent_tabs.editing %}
            <button class="tab-header" data-tab="agent-editing">AgenticEdit</button>
            {% endif %}
            <button class="tab-header" data-tab="data">Data</button>
            <button class="tab-header" data-tab="log">Log</button>
            <button class="tab-header" data-tab="settings">Settings</button>
            <button class="tab-header" data-tab="about">About</button>
        </div>

        <div class="tab-content">
            <!-- Image Tab -->
            <div class="tab-pane active" data-tab="image">
                <h2>Image</h2>
                <p class="tab-description">Rotate, crop, and save your image.</p>

                <div class="image-tab-section">
                    <h3>Rotation</h3>
                    <div class="image-action-buttons">
                        <button type="button" class="btn btn-secondary" id="rotateLeftBtnTab" title="Rotate left 90 degrees">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 4v6h6"/>
                                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                            </svg>
                            Rotate Left
                        </button>
                        <button type="button" class="btn btn-secondary" id="rotateRightBtnTab" title="Rotate right 90 degrees">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            Rotate Right
                        </button>
                    </div>
                </div>

                <div class="image-tab-section">
                    <h3>Crop</h3>
                    <p class="hint">Select an area of the image to keep.</p>
                    <div class="crop-controls">
                        <button type="button" class="btn btn-secondary" id="cropBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2v4H2v14h14v-4h4V2H6z"/>
                                <path d="M6 6h8v8"/>
                            </svg>
                            Start Crop
                        </button>
                        <span id="cropStatus" class="crop-status"></span>
                    </div>
                    <div class="crop-action-buttons" id="cropActionButtons" style="display: none;">
                        <button type="button" class="btn btn-primary btn-sm" id="cropConfirmBtn">Apply Crop</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cropCancelBtn">Cancel</button>
                    </div>
                    <div class="autocrop-controls">
                        <button type="button" class="btn btn-secondary" id="autocropBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M9 9h6v6H9z"/>
                            </svg>
                            Autocrop
                        </button>
                        <span class="hint" style="margin-left: 0.5rem;">Remove empty borders</span>
                    </div>
                </div>

                <div class="image-tab-section save-section">
                    <h3>Save</h3>
                    <div class="save-controls">
                        <button type="button" class="btn btn-primary" id="saveAnnotationsBtn">
                            Save Annotations
                        </button>
                        <span id="unsavedIndicatorImage" class="unsaved-indicator" style="display: none;">Unsaved</span>
                    </div>
                    <p class="hint">Save tubercle and connection data to annotation files.</p>
                </div>
            </div>

            <!-- Calibration Tab -->
            <div class="tab-pane" data-tab="calibration">
                <h2>Calibration <a href="/static/help/calibration.html#default-estimate" class="help-icon" target="_blank" title="Calibration Help">?</a></h2>
                <p class="tab-description">Set the scale for measurements.</p>

                <div class="calibration-display-section">
                    <h3>Current Calibration</h3>
                    <div class="calibration-display">
                        <span id="calibrationValue">Not set</span>
                        <span id="calibrationMethod" class="calibration-method-badge" style="display: none;"></span>
                    </div>
                </div>

                <div class="calibration-section-header">Automatic Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Auto-Estimate</h3>
                    <p class="hint">Use estimated calibration based on 700x magnification and 1024px image width (~0.14 µm/pixel). See <a href="/static/help/calibration.html#default-estimate" target="_blank">help</a> for details.</p>
                    <div class="estimate-controls">
                        <button type="button" class="btn btn-secondary" id="applyEstimateBtn">Apply Estimate</button>
                    </div>
                </div>

                <div class="calibration-section-header">Manual Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Scale Bar Measurement</h3>
                    <p class="hint">Enter the known length of a scale bar.</p>
                    <div class="calibration-inputs">
                        <input type="number" id="scaleUm" placeholder="µm" min="0" step="0.1">
                        <span>=</span>
                        <input type="number" id="scalePx" placeholder="pixels" min="1" step="1">
                        <button type="button" class="btn btn-sm btn-primary" id="applyCalibrationBtn">Apply</button>
                    </div>
                </div>

                <div class="calibration-method-section">
                    <h3>Direct Input</h3>
                    <p class="hint">Enter the calibration value directly.</p>
                    <div class="calibration-inputs">
                        <input type="number" id="umPerPx" placeholder="µm/pixel" min="0" step="0.001">
                        <button type="button" class="btn btn-sm btn-primary" id="applyDirectBtn">Apply</button>
                    </div>
                </div>

                <div class="calibration-section-header">Graphical Scale Specification</div>

                <div class="calibration-method-section">
                    <h3>Measure on Image</h3>
                    <p class="hint">Draw a line on a known scale bar in the image.</p>
                    <div class="measure-controls">
                        <button type="button" class="btn btn-secondary" id="measureScaleBtn">Manually Draw Scale Bar</button>
                        <span id="measureStatus" class="measure-status"></span>
                    </div>
                </div>
            </div>

            <!-- Extraction Tab (combined with Configure) -->
            <div class="tab-pane" data-tab="extraction">
                <h2>Extraction <span id="unsavedIndicator" class="unsaved-indicator" style="display: none;">Unsaved</span></h2>
                <p class="tab-description">Configure parameters and extract tubercles and connections.</p>

                <!-- Current Set Header -->
                <div class="tab-set-header" id="extractionTabSetHeader">
                    <span class="tab-set-label">Current Set:</span>
                    <div class="tab-set-dropdown" id="extractionTabSetDropdown">
                        <button type="button" class="tab-set-btn" id="extractionTabSetBtn">
                            <span id="extractionTabSetName">Base</span>
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="tab-set-menu" id="extractionTabSetMenu" style="display: none;">
                            <!-- Set list populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="config-section collapsible-section">
                    <h3 class="collapsible-header" id="profilePresetsToggle">
                        <span class="collapse-icon">&#9660;</span>
                        Profile Presets
                    </h3>
                    <div class="collapsible-content" id="profilePresetsContent">
                        <div class="param-row">
                            <label for="profileSelect">Apply Profile</label>
                            <select id="profileSelect" class="param-select">
                                <option value="">-- Select Profile --</option>
                            </select>
                        </div>
                        <div class="profile-management">
                            <h4>Save Current Settings</h4>
                            <div class="profile-save-row">
                                <input type="text" id="newProfileName" class="profile-name-input"
                                       placeholder="Profile name...">
                                <button type="button" class="btn btn-sm btn-primary" id="saveProfileBtn">Save</button>
                            </div>
                            <h4>Your Profiles</h4>
                            <div id="profileListContainer">
                                <p class="empty-profiles">No user profiles saved yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Detection Parameters</h3>

                    <div class="param-row">
                        <label for="method">
                            Method
                            <a href="#" class="help-icon" data-param="method" title="Help">?</a>
                        </label>
                        <select id="method" class="param-input param-select">
                            <option value="log">LoG (Laplacian of Gaussian)</option>
                            <option value="dog">DoG (Difference of Gaussian)</option>
                            <option value="ellipse">Ellipse Fitting</option>
                            <option value="lattice">Lattice-aware</option>
                        </select>
                    </div>

                    <div class="param-row">
                        <label for="threshold">
                            Threshold
                            <a href="#" class="help-icon" data-param="threshold" title="Help">?</a>
                        </label>
                        <input type="range" id="threshold" class="param-input param-range"
                               min="0.01" max="0.50" step="0.001" value="0.05">
                        <input type="number" id="threshold_value" class="param-value param-value-editable"
                               min="0.01" max="0.50" step="0.001" value="0.050">
                    </div>

                    <div class="param-row">
                        <label for="min_diameter_um">
                            Min Diameter (um)
                            <a href="#" class="help-icon" data-param="min-diameter" title="Help">?</a>
                        </label>
                        <input type="number" id="min_diameter_um" class="param-input param-number"
                               min="0.5" max="20" step="0.5" value="2.0">
                    </div>

                    <div class="param-row">
                        <label for="max_diameter_um">
                            Max Diameter (um)
                            <a href="#" class="help-icon" data-param="max-diameter" title="Help">?</a>
                        </label>
                        <input type="number" id="max_diameter_um" class="param-input param-number"
                               min="1" max="50" step="0.5" value="10.0">
                    </div>

                    <div class="param-row">
                        <label for="min_circularity">
                            Circularity
                            <a href="#" class="help-icon" data-param="circularity" title="Help">?</a>
                        </label>
                        <input type="range" id="min_circularity" class="param-input param-range"
                               min="0.01" max="1" step="0.001" value="0.5">
                        <input type="number" id="min_circularity_value" class="param-value param-value-editable"
                               min="0.01" max="1" step="0.001" value="0.500">
                    </div>
                </div>

                <div class="config-section">
                    <h3>Preprocessing</h3>

                    <div class="param-row">
                        <label for="clahe_clip">
                            CLAHE Clip
                            <a href="#" class="help-icon" data-param="clahe-clip" title="Help">?</a>
                        </label>
                        <input type="range" id="clahe_clip" class="param-input param-range"
                               min="0.01" max="0.20" step="0.001" value="0.03">
                        <input type="number" id="clahe_clip_value" class="param-value param-value-editable"
                               min="0.01" max="0.20" step="0.001" value="0.030">
                    </div>

                    <div class="param-row">
                        <label for="clahe_kernel">
                            CLAHE Kernel
                            <a href="#" class="help-icon" data-param="clahe-kernel" title="Help">?</a>
                        </label>
                        <input type="number" id="clahe_kernel" class="param-input param-number"
                               min="4" max="32" step="2" value="8">
                    </div>

                    <div class="param-row">
                        <label for="blur_sigma">
                            Blur Sigma
                            <a href="#" class="help-icon" data-param="blur-sigma" title="Help">?</a>
                        </label>
                        <input type="range" id="blur_sigma" class="param-input param-range"
                               min="0" max="5" step="0.001" value="1.0">
                        <input type="number" id="blur_sigma_value" class="param-value param-value-editable"
                               min="0" max="5" step="0.001" value="1.000">
                    </div>
                </div>

                <div class="config-section">
                    <h3>Neighbor Graph</h3>

                    <div class="param-row">
                        <label for="neighbor_graph">
                            Graph Type
                            <a href="#" class="help-icon" data-param="neighbor-graph-type" title="Help">?</a>
                        </label>
                        <select id="neighbor_graph" class="param-input param-select">
                            <option value="delaunay">Delaunay</option>
                            <option value="gabriel">Gabriel</option>
                            <option value="rng">RNG (Recommended)</option>
                        </select>
                    </div>

                    <div class="param-row">
                        <label>
                            <input type="checkbox" id="cull_long_edges" checked>
                            Cull Long Edges
                            <a href="#" class="help-icon" data-param="cull-long-edges" title="Help">?</a>
                        </label>
                    </div>

                    <div class="param-row" id="cullFactorRow">
                        <label for="cull_factor">
                            Cull Factor
                            <a href="#" class="help-icon" data-param="cull-factor" title="Help">?</a>
                        </label>
                        <input type="number" id="cull_factor" class="param-input param-number"
                               min="1.0" max="5.0" step="0.1" value="1.8">
                        <span class="param-hint">× avg length</span>
                    </div>
                </div>

                <div class="config-actions">
                    <button type="button" class="btn btn-secondary btn-sm" id="undoParamsBtn" disabled title="No undo history">Undo</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="resetParamsBtn">Reset to Defaults</button>
                </div>

                <div class="extraction-actions">
                    <h3>Run Extraction</h3>
                    <div class="extraction-buttons">
                        <button type="button" class="btn btn-primary" id="extractBtn">
                            Extract Tubercles + Connections
                        </button>
                        <button type="button" class="btn btn-secondary" id="extractConnectionsBtn" title="Clear and regenerate connections using current tubercles">
                            Extract Connections Only
                        </button>
                        <span class="spinner" id="extractSpinner" style="display: none;"></span>
                    </div>
                    <span id="paramsChangedIndicator" class="params-changed-indicator" style="display: none;">
                        Parameters changed
                    </span>
                </div>

                <!-- Optimization Section -->
                <div class="config-section optimization-section">
                    <h3>Optimize Parameters</h3>
                    <p class="hint">Automatically tune parameters to maximize hexagonalness score using gradient ascent.</p>

                    <!-- Parameter Selection -->
                    <div class="optimize-params-select">
                        <h4>Parameters to Optimize</h4>
                        <div class="optimize-param-checkboxes">
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="threshold">
                                <span>Threshold</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="min_diameter_um">
                                <span>Min Diameter</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="max_diameter_um">
                                <span>Max Diameter</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="min_circularity">
                                <span>Circularity</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="clahe_clip">
                                <span>CLAHE Clip</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="clahe_kernel">
                                <span>CLAHE Kernel</span>
                            </label>
                            <label class="optimize-param-label">
                                <input type="checkbox" class="optimize-param-checkbox" data-param="blur_sigma">
                                <span>Blur Sigma</span>
                            </label>
                        </div>
                    </div>

                    <!-- Optimization Settings -->
                    <div class="optimize-settings">
                        <div class="param-row">
                            <label for="optimizeDeltaThreshold">Convergence Delta</label>
                            <input type="number" id="optimizeDeltaThreshold" class="param-input param-number"
                                   min="0.0001" max="0.01" step="0.0001" value="0.001">
                        </div>
                        <div class="param-row">
                            <label for="optimizeMaxIterations">Max Iterations</label>
                            <input type="number" id="optimizeMaxIterations" class="param-input param-number"
                                   min="1" max="50" step="1" value="20">
                        </div>
                        <div class="param-row">
                            <label for="optimizeTargetScore">Target Score</label>
                            <input type="number" id="optimizeTargetScore" class="param-input param-number"
                                   min="0.5" max="1.0" step="0.05" value="0.85">
                        </div>
                    </div>

                    <!-- Status Display -->
                    <div class="optimize-status-panel">
                        <div class="optimize-status-row">
                            <span class="optimize-status-label">Status:</span>
                            <span id="optimizeStatus" class="optimize-status-value">Ready</span>
                        </div>
                        <div class="optimize-status-row">
                            <span class="optimize-status-label">Iteration:</span>
                            <span id="optimizeIteration" class="optimize-status-value">-</span>
                            <span>/</span>
                            <span id="optimizeMaxIter">20</span>
                        </div>
                        <div class="optimize-status-row">
                            <span class="optimize-status-label">Hexagonalness:</span>
                            <span id="optimizeHexScore" class="optimize-status-value">-</span>
                            <span id="optimizeHexDelta" class="optimize-delta"></span>
                        </div>
                        <div class="optimize-status-row">
                            <span class="optimize-status-label">Best Score:</span>
                            <span id="optimizeBestScore" class="optimize-status-value">-</span>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="optimize-controls">
                        <button type="button" class="btn btn-secondary" id="optimizeStepBtn" title="Run one gradient step">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Step
                        </button>
                        <button type="button" class="btn btn-primary" id="optimizeAutoBtn" title="Run until convergence">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                                <line x1="19" y1="5" x2="19" y2="19"/>
                            </svg>
                            Auto
                        </button>
                        <button type="button" class="btn btn-secondary" id="optimizeStopBtn" title="Stop optimization" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                            Stop
                        </button>
                        <span class="spinner" id="optimizeSpinner" style="display: none;"></span>
                    </div>
                </div>

            </div>

            <!-- Edit Tab -->
            <div class="tab-pane" data-tab="edit">
                <h2>Edit <a href="#" class="help-icon" data-edit="overview" title="Editing Help">?</a></h2>
                <p class="tab-description">Manually edit tubercles and connections.</p>
                <p class="edit-mode-hint" id="editModeHint" style="display: none;"></p>

                <!-- Editing Set Indicator -->
                <div class="editing-set-indicator" id="editTabSetIndicator">
                    <span class="editing-set-label">Editing:</span>
                    <span class="editing-set-name" id="editTabSetName">Base</span>
                </div>

                <div class="edit-section">
                    <h3>Add</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="addTubBtn" title="Add new tubercle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            Add Tubercle
                        </button>
                        <a href="#" class="help-icon" data-edit="add-tubercle" title="Help">?</a>
                        <button type="button" class="btn btn-secondary" id="addItcBtn" title="Add connection between tubercles">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="12" r="3"/>
                                <line x1="9" y1="12" x2="15" y2="12"/>
                            </svg>
                            Add ITC
                        </button>
                        <a href="#" class="help-icon" data-edit="add-connection" title="Help">?</a>
                        <button type="button" class="btn btn-secondary" id="addChainBtn" title="Add connected tubercles in a chain">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="4" cy="12" r="2.5"/>
                                <circle cx="12" cy="12" r="2.5"/>
                                <circle cx="20" cy="12" r="2.5"/>
                                <line x1="6.5" y1="12" x2="9.5" y2="12"/>
                                <line x1="14.5" y1="12" x2="17.5" y2="12"/>
                            </svg>
                            Chain Mode
                        </button>
                        <a href="#" class="help-icon" data-edit="add-chain" title="Help">?</a>
                    </div>
                    <div class="default-diameter-control" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                        <label for="defaultTubercleDiameter" class="param-label">Default Diameter (µm):</label>
                        <input type="number" id="defaultTubercleDiameter" class="param-input"
                               step="0.001" min="0.001" placeholder="auto"
                               title="Diameter for new tubercles. Leave empty to use mean of existing tubercles.">
                        <a href="#" class="help-icon" data-edit="default-diameter" title="Help">?</a>
                        <span class="hint" id="defaultDiameterHint" style="margin-left: 0.5rem; font-size: 0.85em;">Requires calibration</span>
                    </div>
                    <div class="auto-size-control" style="margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="autoSizeEnabled" disabled
                                   title="When enabled, analyzes the image at click location to determine optimal tubercle size">
                            <span>Auto-size from image</span>
                            <a href="#" class="help-icon" data-edit="auto-size" title="Help">?</a>
                        </label>
                        <span class="hint" id="autoSizeHint" style="margin-left: 1.5rem; font-size: 0.85em; display: block;">Requires calibration</span>
                        <div class="auto-size-options" style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <label for="autoSizeRegionFactor" style="font-size: 0.85em; min-width: 80px;">Region size:</label>
                                <input type="range" id="autoSizeRegionFactor" min="1" max="10" value="6" step="1"
                                       style="flex: 1; max-width: 100px;"
                                       title="Multiplier for detection region size (larger = more stable but slower)">
                                <span id="autoSizeRegionFactorValue" style="font-size: 0.85em; min-width: 25px;">6x</span>
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.85em;">
                                <input type="checkbox" id="autoSizeShowRegion"
                                       title="Briefly show the analyzed region on the image">
                                <span>Show analyzed region</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Modify Tubercle</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="moveBtn" disabled title="Move selected tubercle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="5 9 2 12 5 15"/>
                                <polyline points="9 5 12 2 15 5"/>
                                <polyline points="15 19 12 22 9 19"/>
                                <polyline points="19 9 22 12 19 15"/>
                                <line x1="2" y1="12" x2="22" y2="12"/>
                                <line x1="12" y1="2" x2="12" y2="22"/>
                            </svg>
                            Move
                        </button>
                        <a href="#" class="help-icon" data-edit="move" title="Help">?</a>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteTubBtn" disabled title="Delete selected tubercle (Del)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Selected
                        </button>
                        <a href="#" class="help-icon" data-edit="delete-selected" title="Help">?</a>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteMultipleTubBtn" disabled title="Click tubercles to delete them (requires 'Allow delete without confirmation')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Multiple
                        </button>
                        <a href="#" class="help-icon" data-edit="delete-multiple-tub" title="Help">?</a>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Modify Connection</h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteItcBtn" disabled title="Delete selected connection (Del)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Selected
                        </button>
                        <a href="#" class="help-icon" data-edit="delete-itc" title="Help">?</a>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteMultipleItcBtn" disabled title="Click connections to delete them (requires 'Allow delete without confirmation')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Multiple
                        </button>
                        <a href="#" class="help-icon" data-edit="delete-multiple-itc" title="Help">?</a>
                    </div>
                    <div class="edit-buttons" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn btn-secondary" id="regenerateConnectionsBtn" disabled title="Clear all connections and regenerate using selected graph type">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"/>
                                <path d="M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                            Regenerate
                        </button>
                        <select id="editGraphType" class="param-select" style="width: auto; min-width: 100px;" title="Graph type for connection generation">
                            <option value="delaunay">Delaunay</option>
                            <option value="gabriel" selected>Gabriel</option>
                            <option value="rng">RNG</option>
                        </select>
                        <a href="#" class="help-icon" data-edit="regenerate-connections" title="Help">?</a>
                    </div>
                </div>

                <div class="edit-section" id="radiusControls">
                    <h3>Radius Adjustment <a href="#" class="help-icon" data-edit="radius" title="Help">?</a></h3>
                    <p class="hint" id="radiusHintSelect">Select a tubercle to resize</p>
                    <div class="radius-controls" id="radiusControlsInner">
                        <button type="button" class="btn btn-icon btn-sm" id="radiusDecBtn" title="Decrease radius" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <input type="range" id="radiusSlider" min="2" max="50" step="0.5" value="10" disabled>
                        <button type="button" class="btn btn-icon btn-sm" id="radiusIncBtn" title="Increase radius" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                        </button>
                        <span id="radiusValue" class="radius-value">10.0px</span>
                    </div>
                    <p class="hint" id="radiusHintUsage" style="display: none;">Use slider or +/- buttons. Arrow keys nudge by 1px.</p>
                </div>

                <div class="edit-section">
                    <h3>History <a href="#" class="help-icon" data-edit="undo-redo" title="Help">?</a></h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="undoBtn" disabled title="Undo (Ctrl+Z)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v6h6"/>
                                <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                            </svg>
                            Undo
                        </button>
                        <button type="button" class="btn btn-secondary" id="redoBtn" disabled title="Redo (Ctrl+Y)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 7v6h-6"/>
                                <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
                            </svg>
                            Redo
                        </button>
                    </div>
                </div>

                <div class="edit-section">
                    <h3>Area Selection <a href="#" class="help-icon" data-edit="area-select" title="Help">?</a></h3>
                    <div class="edit-buttons">
                        <button type="button" class="btn btn-secondary" id="areaSelectBtn" title="Draw rectangle to select multiple items">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 3v18"/>
                            </svg>
                            Area Select
                        </button>
                        <button type="button" class="btn btn-secondary btn-danger" id="deleteSelectedBtn" disabled title="Delete all selected items">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete Selected (0)
                        </button>
                        <button type="button" class="btn btn-secondary btn-danger" id="clearAllBtn" title="Delete all tubercles and connections from current set">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <span id="multiSelectStatus" class="hint" style="margin-top: 0.5rem; display: block;">No items selected</span>
                </div>

                <div class="edit-section">
                    <h3>Options <a href="#" class="help-icon" data-edit="options" title="Help">?</a></h3>
                    <div class="setting-item">
                        <label class="setting-label">
                            <input type="checkbox" id="allowDeleteWithoutConfirm">
                            <span>Allow delete without confirmation</span>
                        </label>
                    </div>
                </div>

                <div class="edit-status-section">
                    <span id="editStatus" class="edit-status"></span>
                </div>

                <div class="edit-shortcuts">
                    <h3>Keyboard Shortcuts</h3>
                    <table class="shortcuts-table">
                        <tr><td><kbd>F1</kbd> or <kbd>?</kbd></td><td>Show all shortcuts</td></tr>
                        <tr><td><kbd>Delete</kbd></td><td>Delete selected</td></tr>
                        <tr><td><kbd>Escape</kbd></td><td>Cancel / Deselect</td></tr>
                        <tr><td><kbd>Tab</kbd></td><td>Cycle selection</td></tr>
                        <tr><td><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
                        <tr><td><kbd>Ctrl+Y</kbd></td><td>Redo</td></tr>
                        <tr><td><kbd>Ctrl+S</kbd></td><td>Save Annotations</td></tr>
                        <tr><td><kbd>Ctrl+N</kbd></td><td>New set</td></tr>
                        <tr><td><kbd>Ctrl+1-9</kbd></td><td>Switch to set</td></tr>
                        <tr><td><kbd>Arrow keys</kbd></td><td>Nudge 1px</td></tr>
                    </table>
                </div>
            </div>

            <!-- Data Tab -->
            <div class="tab-pane" data-tab="data">
                <h2>Data</h2>

                <!-- Panel 1: Image-Level Data (solid border, not collapsible) -->
                <div class="data-panel data-panel-stored" id="imageLevelPanel">
                    <h3 class="data-panel-header">
                        <span>Image-Level Data</span>
                        <span class="data-panel-badge stored-badge">Stored</span>
                    </h3>
                    <div class="data-panel-content">
                        <div class="data-row">
                            <span class="data-label">Current Calibration:</span>
                            <span id="dataCurrentCalibration" class="data-value">-</span>
                            <span class="data-unit">µm/px</span>
                        </div>
                        <div class="data-row data-row-secondary">
                            <span class="data-label">Source:</span>
                            <span id="dataCalibrationSource" class="data-value-secondary">-</span>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Set Data (solid border) -->
                <div class="data-panel data-panel-stored" id="setDataPanel">
                    <h3 class="data-panel-header">
                        <span>Set Data</span>
                        <span class="data-panel-badge stored-badge">Stored</span>
                        <div class="tab-set-dropdown" id="dataTabSetDropdown">
                            <button type="button" class="tab-set-btn" id="dataTabSetBtn">
                                <span id="dataTabSetName">Base</span>
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="tab-set-menu" id="dataTabSetMenu" style="display: none;">
                                <!-- Set list populated by JavaScript -->
                            </div>
                        </div>
                    </h3>
                    <div class="data-panel-content">
                        <!-- Calibration Snapshot -->
                        <div class="data-row">
                            <span class="data-label">Set Calibration:</span>
                            <span id="dataSetCalibration" class="data-value">-</span>
                            <span class="data-unit">µm/px</span>
                        </div>
                        <div id="calibrationMismatchWarning" class="calibration-mismatch-warning" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <span>Calibration mismatch! Set uses <span id="mismatchSetCal">-</span>, current is <span id="mismatchCurrentCal">-</span></span>
                            <button type="button" class="btn btn-sm" id="recalculateBtn">Recalculate</button>
                        </div>

                        <!-- Extraction Parameters (collapsible, default collapsed) -->
                        <div class="data-subsection collapsible-section">
                            <h4 class="collapsible-header collapsed" id="paramsHeader">
                                <span class="collapse-icon">▼</span>
                                <span>Extraction Parameters</span>
                            </h4>
                            <div class="collapsible-content" id="paramsContent" style="display: none;">
                                <div id="setParamsDisplay" class="set-params-display">
                                    <span class="empty-state">No parameters recorded</span>
                                </div>
                            </div>
                        </div>

                        <!-- TUB Table (collapsible) -->
                        <div class="data-subsection collapsible-section">
                            <h4 class="collapsible-header" id="tubHeader">
                                <span class="collapse-icon">▼</span>
                                <span>Tubercles (TUB)</span>
                                <span id="tubCount" class="item-count">0</span>
                                <div class="column-toggles" id="tubColumnToggles">
                                    <!-- Populated by JS -->
                                </div>
                            </h4>
                            <div class="collapsible-content" id="tubContent">
                                <div class="data-table-container">
                                    <table class="data-table" id="tubTable">
                                        <thead>
                                            <tr>
                                                <th data-col="id">ID</th>
                                                <th data-col="x" id="tubColX">X (px)</th>
                                                <th data-col="y" id="tubColY">Y (px)</th>
                                                <th data-col="diam">Diam (µm)</th>
                                                <th data-col="circ">Circ</th>
                                                <th data-col="bdry">Bdry</th>
                                                <th data-col="source" class="col-optional">Source</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tubTableBody">
                                            <tr><td colspan="7" class="empty-table">No tubercles detected</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- ITC Table (collapsible) -->
                        <div class="data-subsection collapsible-section">
                            <h4 class="collapsible-header" id="itcHeader">
                                <span class="collapse-icon">▼</span>
                                <span>Intertubercular Connections (ITC)</span>
                                <span id="itcCount" class="item-count">0</span>
                            </h4>
                            <div class="collapsible-content" id="itcContent">
                                <div class="data-table-container">
                                    <table class="data-table" id="itcTable">
                                        <thead>
                                            <tr>
                                                <th>ID1</th>
                                                <th>ID2</th>
                                                <th>Center (µm)</th>
                                                <th>Edge (µm)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itcTableBody">
                                            <tr><td colspan="4" class="empty-table">No connections detected</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Computed Statistics (dashed border) -->
                <div class="data-panel data-panel-computed" id="computedStatsPanel">
                    <h3 class="data-panel-header">
                        <span>Computed Statistics</span>
                        <span class="data-panel-badge computed-badge">Computed</span>
                    </h3>
                    <div class="data-panel-content">
                        <div id="statisticsPanel" class="statistics-panel">
                            <div class="stat-row">
                                <span class="stat-label">Tubercles:</span>
                                <span id="statNTubercles" class="stat-value">-</span>
                                <span class="stat-detail" id="statBoundaryDetail"></span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mean Diameter:</span>
                                <span id="statMeanDiameter" class="stat-value">-</span>
                                <span class="stat-unit">µm</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Connections:</span>
                                <span id="statNEdges" class="stat-value">-</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Mean Space:</span>
                                <span id="statMeanSpace" class="stat-value">-</span>
                                <span class="stat-unit">µm</span>
                            </div>
                            <div class="stat-row classification">
                                <span class="stat-label">Classification:</span>
                                <span id="statGenus" class="stat-value">-</span>
                                <span id="statConfidence" class="stat-confidence">-</span>
                            </div>
                            <hr class="stat-divider">
                            <div class="stat-row hexagonalness">
                                <span class="stat-label">Hexagonalness:</span>
                                <span id="statHexScore" class="stat-value stat-score">-</span>
                                <span class="stat-unit">/ 1.0</span>
                                <a href="#" class="help-icon" data-help="hexagonalness" title="Help">?</a>
                                <span id="statHexReliability" class="stat-reliability"></span>
                            </div>
                            <div class="stat-row stat-indent">
                                <span class="stat-label">Spacing Uniformity:</span>
                                <span id="statSpacingUniformity" class="stat-value">-</span>
                                <span class="stat-unit" id="statSpacingWeight">(40%)</span>
                                <a href="#" class="help-icon" data-help="spacing-uniformity" title="Help">?</a>
                            </div>
                            <div class="stat-row stat-indent">
                                <span class="stat-label">Degree Score:</span>
                                <span id="statDegreeScore" class="stat-value">-</span>
                                <span class="stat-unit" id="statDegreeWeight">(45%)</span>
                                <a href="#" class="help-icon" data-help="degree-score" title="Help">?</a>
                            </div>
                            <div class="stat-row stat-indent">
                                <span class="stat-label">Edge Ratio Score:</span>
                                <span id="statEdgeRatioScore" class="stat-value">-</span>
                                <span class="stat-unit" id="statEdgeRatioWeight">(15%)</span>
                                <a href="#" class="help-icon" data-help="edge-ratio-score" title="Help">?</a>
                            </div>
                            <div class="stat-row stat-secondary">
                                <span class="stat-label">Spacing CV:</span>
                                <span id="statSpacingCV" class="stat-value">-</span>
                                <a href="#" class="help-icon" data-help="spacing-cv" title="Help">?</a>
                            </div>
                            <div class="stat-row stat-secondary">
                                <span class="stat-label">Mean Degree:</span>
                                <span id="statMeanDegree" class="stat-value">-</span>
                                <span class="stat-unit">neighbors</span>
                                <a href="#" class="help-icon" data-help="mean-degree" title="Help">?</a>
                            </div>
                        </div>

                        <!-- Dataset History Section (collapsible, default collapsed) -->
                        <div class="data-subsection history-section collapsible-section">
                            <h4 class="collapsible-header collapsed" id="historyHeader">
                                <span class="collapse-icon">▼</span>
                                <span>Dataset History</span>
                            </h4>
                            <div class="collapsible-content" id="historyContent" style="display: none;">
                                <div class="history-empty" id="historyEmpty">No history events recorded</div>
                                <div class="history-timeline" id="historyTimeline">
                                    <!-- History events populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Tab -->
            <div class="tab-pane" data-tab="log">
                <h2>Log</h2>
                <div class="log-container">
                    <table class="log-table" id="logTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Event</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane" data-tab="settings">
                <h2>Settings</h2>
                <div class="settings-content">
                    <!-- User Settings -->
                    <div class="settings-group" id="settingsUser">
                        <div class="settings-group-header">
                            <h3>User</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <label class="setting-label-text">Your Name</label>
                                <p class="setting-hint">Used for attribution in dataset history tracking.</p>
                                <div class="user-input-row">
                                    <input type="text" id="userNameInput" class="user-name-input" placeholder="Enter your name...">
                                    <button type="button" class="btn btn-sm btn-primary" id="saveUserBtn">Save</button>
                                </div>
                                <span id="userSourceIndicator" class="user-source-hint"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Settings -->
                    <div class="settings-group" id="settingsNavigation">
                        <div class="settings-group-header">
                            <h3>Navigation</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="scrollWheelZoom" checked>
                                    <span>Enable scroll wheel zoom</span>
                                </label>
                                <p class="setting-hint">When disabled, use the zoom buttons or keyboard shortcuts (+/-) instead.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Overlay Display Settings -->
                    <div class="settings-group" id="settingsOverlay">
                        <div class="settings-group-header">
                            <h3>Overlay Display</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <label class="setting-label">
                                    <input type="checkbox" id="showTubercleIds">
                                    <span>Show tubercle IDs</span>
                                </label>
                                <p class="setting-hint">Display ID numbers on each detected tubercle.</p>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">ID text size</label>
                                <div class="range-with-value">
                                    <input type="range" id="idTextSize" min="8" max="24" step="1" value="12">
                                    <span class="range-value" id="idTextSizeValue">12px</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Tubercle color</label>
                                <div class="color-input-row">
                                    <input type="color" id="tubercleColorPicker" value="#00ffff">
                                    <input type="text" id="tubercleColorText" value="#00ffff" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Connection color</label>
                                <div class="color-input-row">
                                    <input type="color" id="connectionColorPicker" value="#ffff00">
                                    <input type="text" id="connectionColorText" value="#ffff00" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Grid color</label>
                                <div class="color-input-row">
                                    <input type="color" id="gridColorPicker" value="#ff88ff">
                                    <input type="text" id="gridColorText" value="#ff88ff" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Grid opacity</label>
                                <div class="slider-row">
                                    <input type="range" id="gridOpacitySlider" min="0.1" max="1.0" step="0.05" value="0.35">
                                    <span id="gridOpacityValue" class="slider-value">35%</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Connection endpoints</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="connectionEndpoint" id="connectionToCenter" value="center" checked>
                                        <span>Draw to tubercle center</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="connectionEndpoint" id="connectionToEdge" value="edge">
                                        <span>Draw to tubercle edge</span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Tubercle color mode</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="tubercleColorMode" id="colorModeUniform" value="uniform">
                                        <span>Uniform color</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="tubercleColorMode" id="colorModeSource" value="source" checked>
                                        <span>By source (extracted/manual)</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="tubercleColorMode" id="colorModeBoundary" value="boundary">
                                        <span>By boundary (interior/boundary)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-item" id="boundaryColorSetting">
                                <label class="setting-label-text">Boundary tubercle color</label>
                                <div class="color-input-row">
                                    <input type="color" id="boundaryTubercleColorPicker" value="#ff8800">
                                    <input type="text" id="boundaryTubercleColorText" value="#ff8800" maxlength="7">
                                </div>
                            </div>

                            <div class="setting-item setting-divider">
                                <label class="setting-label">
                                    <input type="checkbox" id="showCalibrationScale">
                                    <span>Show calibration scale</span>
                                </label>
                                <p class="setting-hint">Display a labeled scale bar on the image.</p>
                            </div>

                            <div class="setting-item" id="scalePositionSetting">
                                <label class="setting-label-text">Scale position</label>
                                <select id="scalePosition" class="setting-select">
                                    <option value="top-left">Top-Left</option>
                                    <option value="top-center">Top-Center</option>
                                    <option value="top-right">Top-Right</option>
                                    <option value="middle-left">Middle-Left</option>
                                    <option value="middle-right">Middle-Right</option>
                                    <option value="bottom-left" selected>Bottom-Left</option>
                                    <option value="bottom-center">Bottom-Center</option>
                                    <option value="bottom-right">Bottom-Right</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Colors Settings -->
                    <div class="settings-group collapsed" id="settingsThemeColors">
                        <div class="settings-group-header">
                            <h3>Theme Colors</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <p class="setting-hint">Customize the image panel and container colors.</p>

                            <!-- Theme Mode Selector -->
                            <div class="setting-item">
                                <label class="setting-label-text">Panel Theme</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="panelTheme" id="panelThemeDark" value="dark" checked>
                                        <span>Dark</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="panelTheme" id="panelThemeLight" value="light">
                                        <span>Light</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="panelTheme" id="panelThemeCustom" value="custom">
                                        <span>Custom</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Custom Colors (shown only when Custom is selected) -->
                            <div id="customThemeColors" style="display: none;">
                                <div class="setting-item">
                                    <label class="setting-label-text">Panel Background</label>
                                    <p class="setting-hint">Image panel, stats bar, code blocks</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelBgColorPicker" value="#1e293b">
                                        <input type="text" id="panelBgColorText" value="#1e293b" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Chart Background</label>
                                    <p class="setting-hint">Optimization progress chart</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelBgAltColorPicker" value="#1a1a2e">
                                        <input type="text" id="panelBgAltColorText" value="#1a1a2e" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Primary Text</label>
                                    <p class="setting-hint">Main text on panel backgrounds</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelTextColorPicker" value="#e2e8f0">
                                        <input type="text" id="panelTextColorText" value="#e2e8f0" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Muted Text</label>
                                    <p class="setting-hint">Labels, hints on panel backgrounds</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelTextMutedColorPicker" value="#94a3b8">
                                        <input type="text" id="panelTextMutedColorText" value="#94a3b8" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Dim Text</label>
                                    <p class="setting-hint">Secondary labels, axis text</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelTextDimColorPicker" value="#64748b">
                                        <input type="text" id="panelTextDimColorText" value="#64748b" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Borders</label>
                                    <p class="setting-hint">Borders, scrollbar tracks</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelBorderColorPicker" value="#334155">
                                        <input type="text" id="panelBorderColorText" value="#334155" class="color-text-input">
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label-text">Grid Lines</label>
                                    <p class="setting-hint">Chart grid lines</p>
                                    <div class="color-input-group">
                                        <input type="color" id="panelGridColorPicker" value="#333344">
                                        <input type="text" id="panelGridColorText" value="#333344" class="color-text-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Reset Button -->
                            <div class="setting-item">
                                <button id="resetThemeColorsBtn" class="btn btn-secondary btn-sm">
                                    Reset Theme Colors
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hexagonalness Calculation -->
                    <div class="settings-group collapsed" id="settingsHexagonalness">
                        <div class="settings-group-header">
                            <h3>Hexagonalness Calculation</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <p class="setting-hint">Adjust the weights used in the hexagonalness formula. The sum should equal 1.0.</p>

                            <div class="setting-item">
                                <label class="setting-label-text">Spacing Uniformity Weight</label>
                                <div class="range-with-value">
                                    <input type="range" id="hexSpacingWeight" min="0" max="1" step="0.05" value="0.40">
                                    <span class="range-value" id="hexSpacingWeightValue">0.40</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Degree Score Weight</label>
                                <div class="range-with-value">
                                    <input type="range" id="hexDegreeWeight" min="0" max="1" step="0.05" value="0.45">
                                    <span class="range-value" id="hexDegreeWeightValue">0.45</span>
                                </div>
                            </div>

                            <div class="setting-item">
                                <label class="setting-label-text">Edge Ratio Score Weight</label>
                                <div class="range-with-value">
                                    <input type="range" id="hexEdgeRatioWeight" min="0" max="1" step="0.05" value="0.15">
                                    <span class="range-value" id="hexEdgeRatioWeightValue">0.15</span>
                                </div>
                            </div>

                            <div class="setting-item hex-sum-row">
                                <span class="setting-label-text">Sum:</span>
                                <span id="hexWeightsSum" class="hex-sum-value">1.00</span>
                                <button type="button" class="btn btn-sm btn-secondary" id="normalizeHexWeightsBtn">Normalize</button>
                                <button type="button" class="btn btn-sm btn-secondary" id="resetHexWeightsBtn">Reset</button>
                            </div>

                            <div class="setting-item hex-calc-display">
                                <div class="hex-calc-row">
                                    <span class="hex-calc-label">Hexagonalness:</span>
                                    <span id="hexCalcValue" class="hex-calc-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Future Settings Placeholder -->
                    <div class="settings-group collapsed" id="settingsAdvanced">
                        <div class="settings-group-header">
                            <h3>Advanced</h3>
                            <span class="settings-group-toggle">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="settings-group-content">
                            <div class="setting-item">
                                <p class="setting-hint">Advanced settings will appear here in future updates.</p>
                            </div>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button type="button" class="btn btn-secondary" id="resetSettingsBtn">Reset to Defaults</button>
                    </div>
                </div>
            </div>

            <!-- About Tab -->
            <div class="tab-pane" data-tab="about">
                <h2>About</h2>
                <div class="about-content">
                    <h3>Fish Scale Measurement</h3>
                    <p>Tubercle diameter and intertubercular space extraction from SEM images of ganoid fish scales.</p>

                    <table class="about-table">
                        <tr>
                            <td>Application Version</td>
                            <td>{{ version_info.app_version }} ({{ version_info.app_version_date }})</td>
                        </tr>
                        <tr>
                            <td>Python Version</td>
                            <td>{{ version_info.python_version }}</td>
                        </tr>
                        <tr>
                            <td>NumPy</td>
                            <td>{{ version_info.numpy_version }}</td>
                        </tr>
                        <tr>
                            <td>SciPy</td>
                            <td>{{ version_info.scipy_version }}</td>
                        </tr>
                        <tr>
                            <td>scikit-image</td>
                            <td>{{ version_info.skimage_version }}</td>
                        </tr>
                        <tr>
                            <td>Flask</td>
                            <td>{{ version_info.flask_version }}</td>
                        </tr>
                        <tr>
                            <td>Git Commit</td>
                            <td>{{ version_info.git_hash }}</td>
                        </tr>
                        <tr>
                            <td>Build Date</td>
                            <td>{{ version_info.git_date }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            {% if agent_tabs.extraction %}
            <!-- AgenticExtraction Tab -->
            <div class="tab-pane" data-tab="agent-extraction">
                <h2>AgenticExtraction</h2>
                <p class="tab-description">Configure and run LLM-powered automated tubercle detection.</p>

                <!-- Configuration Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-config">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">Agent Configuration</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div class="agent-config-form">
                        <div class="param-row agent-config-row">
                            <label for="agentProvider">Provider</label>
                            <select id="agentProvider" class="param-input param-select">
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="gemini">Gemini (Google)</option>
                                <option value="openrouter">OpenRouter</option>
                            </select>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="agentModel">Model</label>
                            <select id="agentModel" class="param-input param-select">
                                <option value="">-- Select Model --</option>
                            </select>
                        </div>
                        <div class="param-row agent-config-row model-cost-row">
                            <label></label>
                            <div id="modelCostInfo" class="model-cost-info" style="display: none;"></div>
                        </div>

                        <div class="param-row agent-config-row">
                            <label class="agent-checkbox-label">
                                <input type="checkbox" id="agentUseCurrentParams" checked>
                                <span>Use current parameters</span>
                            </label>
                            <span class="param-hint">Start from existing extraction settings instead of a profile</span>
                        </div>

                        <div class="param-row agent-config-row" id="agentProfileRow">
                            <label for="agentProfile">Detection Profile</label>
                            <select id="agentProfile" class="param-input param-select" disabled>
                                <option value="default">Default</option>
                                <option value="conservative">Conservative (fewer false positives)</option>
                                <option value="aggressive">Aggressive (fewer false negatives)</option>
                            </select>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="agentTargetScore">Target Hexagonalness</label>
                            <input type="number" id="agentTargetScore" class="param-input param-number"
                                   min="0" max="1" step="0.05" value="0.70"
                                   placeholder="0.0-1.0">
                            <span class="param-hint">Target score (0.0-1.0)</span>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="agentMaxIterations">Max Iterations</label>
                            <input type="number" id="agentMaxIterations" class="param-input param-number"
                                   min="5" max="100" step="5" value="30">
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-status">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">Status</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div id="agentStatusPanel" class="agent-status-section">
                        <div class="agent-status-row">
                            <span class="agent-status-label">State:</span>
                            <span id="agentState" class="agent-status-value status-idle">Idle</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Phase:</span>
                            <span id="agentPhase" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Iteration:</span>
                            <span id="agentIteration" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Best Score:</span>
                            <span id="agentBestScore" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Tubercles:</span>
                            <span id="agentTubercleCount" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Last Action:</span>
                            <span id="agentLastAction" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Total Time:</span>
                            <span id="agentElapsed" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Step Time:</span>
                            <span id="agentStepTime" class="agent-status-value">-</span>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Current Parameters Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-params">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">Current Parameters</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div id="agentParamsDisplay" class="agent-params-display">
                        <p class="hint">Parameters will be displayed when agent is configured.</p>
                    </div>
                    </div>
                </div>

                <!-- Progress Chart Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-progress">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">Progress</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div class="agent-chart-container">
                        <canvas id="agentChart"></canvas>
                    </div>
                    </div>
                </div>

                <!-- LLM Communication Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-llm">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">LLM Communication</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">

                    <!-- Last Prompt -->
                    <div class="agent-collapsible collapsed">
                        <div class="agent-collapsible-header">
                            <h4>Last Prompt Sent</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyPromptBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <pre id="agentLastPrompt">No prompt sent yet.</pre>
                        </div>
                    </div>

                    <!-- Last Response -->
                    <div class="agent-collapsible collapsed">
                        <div class="agent-collapsible-header">
                            <h4>Last LLM Response</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyResponseBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <pre id="agentLastResponse">No response received yet.</pre>
                        </div>
                    </div>

                    <!-- Action Summary -->
                    <div class="agent-collapsible collapsed">
                        <div class="agent-collapsible-header">
                            <h4>Action Summary</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyActionsBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <button type="button" class="btn btn-small" id="clearActionsBtn" title="Clear actions">
                                    Clear
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <pre id="agentActionSummary">No actions yet.</pre>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Costs Section -->
                <div class="config-section agent-section agent-section-collapsible" data-section="agent-costs">
                    <h3 class="agent-section-header">
                        <span class="agent-section-title">Costs</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                            <div class="agent-costs-panel">
                                <div class="agent-cost-row">
                                    <span class="agent-cost-label">Model:</span>
                                    <span id="agentCostModel" class="agent-cost-value">-</span>
                                </div>
                                <div class="agent-cost-row">
                                    <span class="agent-cost-label">Input Tokens:</span>
                                    <span id="agentCostInputTokens" class="agent-cost-value">0</span>
                                </div>
                                <div class="agent-cost-row">
                                    <span class="agent-cost-label">Output Tokens:</span>
                                    <span id="agentCostOutputTokens" class="agent-cost-value">0</span>
                                </div>
                                <div class="agent-cost-row">
                                    <span class="agent-cost-label">Total Tokens:</span>
                                    <span id="agentCostTotalTokens" class="agent-cost-value">0</span>
                                </div>
                                <div class="agent-cost-row agent-cost-total">
                                    <span class="agent-cost-label">Estimated Cost:</span>
                                    <span id="agentCostEstimate" class="agent-cost-value">$0.0000</span>
                                </div>
                                <div class="agent-cost-row">
                                    <span class="agent-cost-label">Last Step Cost:</span>
                                    <span id="agentCostLastStep" class="agent-cost-value">$0.0000</span>
                                </div>
                            </div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="extraction-actions agent-section">
                    <h3>Run Agent</h3>
                    <div class="extraction-buttons agent-controls">
                        <button type="button" class="btn btn-primary" id="startAgentBtn">
                            Start AgenticExtraction
                        </button>
                        <button type="button" class="btn btn-secondary" id="stopAgentBtn" disabled>
                            Stop
                        </button>
                        <button type="button" class="btn btn-secondary" id="acceptBestBtn" disabled>
                            Accept Best
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetAgentBtn">
                            Reset
                        </button>
                        <span class="spinner" id="agentSpinner" style="display: none;"></span>
                    </div>
                </div>

                <!-- Status Line (always visible at bottom) -->
                <div class="agent-status-line" id="agentStatusLine">
                    <span class="status-line-item">
                        <span class="status-line-label">State:</span>
                        <span id="agentStatusLineState" class="status-line-value">Idle</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">Iter:</span>
                        <span id="agentStatusLineIter" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">Best:</span>
                        <span id="agentStatusLineBest" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">TUB:</span>
                        <span id="agentStatusLineTub" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">Time:</span>
                        <span id="agentStatusLineTime" class="status-line-value">-</span>
                    </span>
                </div>
            </div>
            {% endif %}

            {% if agent_tabs.editing %}
            <!-- AgenticEdit Tab -->
            <div class="tab-pane" data-tab="agent-editing">
                <h2>AgenticEdit</h2>
                <p class="tab-description">LLM-powered pattern completion to fill gaps and improve hexagonalness.</p>

                <!-- Configuration Section -->
                <div class="config-section agent-section edit-agent-section" data-section="edit-config">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">Configuration</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div class="agent-config-form">
                        <div class="param-row agent-config-row">
                            <label for="editAgentProvider">Provider</label>
                            <select id="editAgentProvider" class="param-input param-select">
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="gemini">Gemini (Google)</option>
                                <option value="openrouter">OpenRouter</option>
                            </select>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="editAgentModel">Model</label>
                            <select id="editAgentModel" class="param-input param-select">
                                <option value="">-- Select Model --</option>
                            </select>
                        </div>
                        <div class="param-row agent-config-row model-cost-row">
                            <label></label>
                            <div id="editModelCostInfo" class="model-cost-info" style="display: none;"></div>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="editAgentMaxIterations">Max Iterations</label>
                            <input type="number" id="editAgentMaxIterations" class="param-input param-number"
                                   min="5" max="100" step="5" value="30">
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="editAgentPlateauThreshold">Plateau Threshold</label>
                            <input type="number" id="editAgentPlateauThreshold" class="param-input param-number"
                                   min="1" max="10" step="1" value="3">
                            <span class="param-hint">Stop after N iterations without improvement</span>
                        </div>

                        <div class="param-row agent-config-row">
                            <label class="agent-checkbox-label">
                                <input type="checkbox" id="editAgentAutoConnect" checked>
                                <span>Auto-connect after completion</span>
                            </label>
                            <select id="editAgentAutoConnectMethod" class="param-input param-select" style="width: 120px; margin-left: 10px;">
                                <option value="gabriel" selected>Gabriel</option>
                                <option value="delaunay">Delaunay</option>
                                <option value="rng">RNG</option>
                            </select>
                        </div>

                        <div class="param-row agent-config-row">
                            <label for="editAgentDebugSeeds">Debug Seeds</label>
                            <select id="editAgentDebugSeeds" class="param-input param-select">
                                <option value="" selected>None</option>
                                <option value="corners">Corners (5 points)</option>
                                <option value="grid3x3">Grid 3×3 (9 points)</option>
                                <option value="cross">Cross (5 points)</option>
                            </select>
                            <span class="param-hint">Coordinate calibration markers</span>
                        </div>

                        <div class="param-row agent-config-row" id="editAgentDebugSeedRadiusRow" style="display: none;">
                            <label for="editAgentDebugSeedRadius">Seed Radius (px)</label>
                            <input type="number" id="editAgentDebugSeedRadius" class="param-input param-number"
                                   min="5" max="50" step="1" value="15">
                        </div>

                        <!-- Agent Goal Selection -->
                        <div class="param-row agent-config-row">
                            <label for="editAgentGoal">Agent Goal</label>
                            <select id="editAgentGoal" class="param-input param-select">
                                <option value="hex_pattern" selected>Hexagonal Pattern Completion</option>
                                <option value="bright_spots">Find N Brightest Spots</option>
                            </select>
                            <span class="param-hint">Task for the VLM agent</span>
                        </div>

                        <!-- Bright Spots Parameters (shown when goal=bright_spots) -->
                        <div id="editAgentBrightSpotsParams" class="agent-goal-params" style="display: none;">
                            <div class="param-row agent-config-row">
                                <label for="editAgentSpotCount">Number of Spots (N)</label>
                                <input type="number" id="editAgentSpotCount" class="param-input param-number"
                                       min="1" max="200" step="1" value="20">
                                <span class="param-hint">Target count of bright spots to find</span>
                            </div>
                            <div class="param-row agent-config-row">
                                <label for="editAgentMinSeparation">Min Separation (px)</label>
                                <input type="number" id="editAgentMinSeparation" class="param-input param-number"
                                       min="10" max="100" step="5" value="30">
                                <span class="param-hint">Minimum pixel distance between spots</span>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Status Section -->
                <div class="config-section agent-section edit-agent-section" data-section="edit-status">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">Status</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div class="agent-status-section">
                        <div class="agent-status-row">
                            <span class="agent-status-label">State:</span>
                            <span id="editAgentState" class="agent-status-value status-idle">Idle</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Phase:</span>
                            <span id="editAgentPhase" class="agent-status-value">-</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Iteration:</span>
                            <span id="editAgentIteration" class="agent-status-value">0/30</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Tubercles:</span>
                            <span id="editAgentTubercleCount" class="agent-status-value">0 (+0)</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Hexagonalness:</span>
                            <span id="editAgentHexagonalness" class="agent-status-value">0.000</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Coverage:</span>
                            <span id="editAgentCoverage" class="agent-status-value">0%</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Elapsed:</span>
                            <span id="editAgentElapsed" class="agent-status-value">0:00</span>
                        </div>
                        <div class="agent-status-row">
                            <span class="agent-status-label">Plateau:</span>
                            <span id="editAgentPlateau" class="agent-status-value">0/3</span>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Progress Chart Section -->
                <div class="config-section agent-section edit-agent-section collapsed" data-section="edit-progress">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">Progress Chart</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                    <div class="agent-chart-container">
                        <canvas id="editAgentChart" width="400" height="200"></canvas>
                    </div>
                    </div>
                </div>

                <!-- Costs Section -->
                <div class="config-section agent-section edit-agent-section collapsed" data-section="edit-costs">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">Costs</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                        <div class="agent-costs-panel">
                            <div class="agent-cost-row">
                                <span class="agent-cost-label">Model:</span>
                                <span id="editAgentCostModel" class="agent-cost-value">-</span>
                            </div>
                            <div class="agent-cost-row">
                                <span class="agent-cost-label">Input Tokens:</span>
                                <span id="editAgentCostInputTokens" class="agent-cost-value">0</span>
                            </div>
                            <div class="agent-cost-row">
                                <span class="agent-cost-label">Output Tokens:</span>
                                <span id="editAgentCostOutputTokens" class="agent-cost-value">0</span>
                            </div>
                            <div class="agent-cost-row agent-cost-total">
                                <span class="agent-cost-label">Estimated Cost:</span>
                                <span id="editAgentCostEstimate" class="agent-cost-value">$0.0000</span>
                            </div>
                            <div class="agent-cost-row">
                                <span class="agent-cost-label">Last Step:</span>
                                <span id="editAgentCostLastStep" class="agent-cost-value">$0.0000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLM Communication Section -->
                <div class="config-section agent-section edit-agent-section collapsed" data-section="edit-llm">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">LLM Communication</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">

                    <!-- Last Prompt -->
                    <div class="agent-collapsible edit-agent-collapsible collapsed">
                        <div class="agent-collapsible-header edit-agent-collapsible-header">
                            <h4>Last Prompt Sent</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyEditPromptBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <pre id="editAgentPrompt">(Waiting for first LLM call...)</pre>
                        </div>
                    </div>

                    <!-- Last Response -->
                    <div class="agent-collapsible edit-agent-collapsible collapsed">
                        <div class="agent-collapsible-header edit-agent-collapsible-header">
                            <h4>Last LLM Response</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyEditResponseBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <pre id="editAgentResponse">(Waiting for agent actions...)</pre>
                        </div>
                    </div>

                    <!-- Action Summary -->
                    <div class="agent-collapsible edit-agent-collapsible collapsed">
                        <div class="agent-collapsible-header edit-agent-collapsible-header">
                            <h4>Action Summary</h4>
                            <div class="agent-collapsible-actions">
                                <button type="button" class="btn btn-small btn-copy" id="copyEditActionsBtn" title="Copy to clipboard">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copy
                                </button>
                                <button type="button" class="btn btn-small" id="clearEditActionsBtn" title="Clear actions">
                                    Clear
                                </button>
                                <span class="agent-collapsible-toggle">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="agent-collapsible-content">
                            <textarea id="editAgentActionLog" class="action-log" readonly>No actions yet.</textarea>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Debug Seed Analysis Section -->
                <div class="config-section agent-section edit-agent-section collapsed" data-section="edit-seed-analysis" id="editSeedAnalysisSection" style="display: none;">
                    <h3 class="edit-agent-section-header">
                        <span class="agent-section-title">🔬 Debug Seed Analysis</span>
                        <span class="agent-section-toggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </h3>
                    <div class="agent-section-content">
                        <div class="seed-analysis-summary">
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Diagnosis:</span>
                                <span id="seedAnalysisDiagnosis" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Confidence:</span>
                                <span id="seedAnalysisConfidence" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Seeds Placed:</span>
                                <span id="seedAnalysisSeedsPlaced" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Mean Position Error:</span>
                                <span id="seedAnalysisMeanError" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Systematic Offset:</span>
                                <span id="seedAnalysisOffset" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Overlapping Tubercles:</span>
                                <span id="seedAnalysisOverlaps" class="seed-analysis-value">-</span>
                            </div>
                            <div class="seed-analysis-row">
                                <span class="seed-analysis-label">Regular Grid Detected:</span>
                                <span id="seedAnalysisGridDetected" class="seed-analysis-value">-</span>
                            </div>
                        </div>

                        <!-- Full Analysis Report -->
                        <div class="agent-collapsible edit-agent-collapsible collapsed">
                            <div class="agent-collapsible-header edit-agent-collapsible-header">
                                <h4>Full Analysis Report</h4>
                                <div class="agent-collapsible-actions">
                                    <button type="button" class="btn btn-small btn-copy" id="copySeedAnalysisBtn" title="Copy to clipboard">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                        Copy
                                    </button>
                                    <span class="agent-collapsible-toggle">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                            <div class="agent-collapsible-content">
                                <pre id="seedAnalysisReport">(Analysis will appear after agent completion...)</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="extraction-actions agent-section">
                    <h3>Controls</h3>
                    <div class="extraction-buttons agent-controls">
                        <button type="button" class="btn btn-primary" id="startEditAgentBtn">
                            <span class="icon">&#9658;</span> Start
                        </button>
                        <button type="button" class="btn btn-danger" id="stopEditAgentBtn" disabled>
                            <span class="icon">&#9632;</span> Stop
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetEditAgentBtn">
                            <span class="icon">&#8634;</span> Reset
                        </button>
                        <button type="button" class="btn btn-success" id="acceptEditResultBtn" disabled>
                            <span class="icon">&#10003;</span> Accept Result
                        </button>
                    </div>
                </div>

                <!-- Status Line -->
                <div class="agent-status-line">
                    <span class="status-line-item">
                        <span class="status-line-label">Hex:</span>
                        <span id="editStatusLineHex" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">Cov:</span>
                        <span id="editStatusLineCov" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">TUB:</span>
                        <span id="editStatusLineTub" class="status-line-value">-</span>
                    </span>
                    <span class="status-line-separator">|</span>
                    <span class="status-line-item">
                        <span class="status-line-label">Plateau:</span>
                        <span id="editStatusLinePlateau" class="status-line-value">-</span>
                    </span>
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Modal for prompts -->
<div class="modal-overlay" id="modalOverlay" style="display: none;">
    <div class="modal" id="modal">
        <div class="modal-header" id="modalHeader">Prompt</div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- Toast notifications -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/user.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script src="{{ url_for('static', filename='js/sets.js') }}"></script>
<script src="{{ url_for('static', filename='js/image.js') }}"></script>
<script src="{{ url_for('static', filename='js/calibration.js') }}"></script>
<script src="{{ url_for('static', filename='js/configure.js') }}"></script>
<script src="{{ url_for('static', filename='js/overlay.js') }}"></script>
<script src="{{ url_for('static', filename='js/data.js') }}"></script>
<script src="{{ url_for('static', filename='js/undo.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/extraction.js') }}"></script>
<script src="{{ url_for('static', filename='js/optimize.js') }}"></script>
<script src="{{ url_for('static', filename='js/setUI.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="{{ url_for('static', filename='js/agent_extraction.js') }}"></script>
<script src="{{ url_for('static', filename='js/agent_editing.js') }}"></script>
<script>
    // MCP state polling for auto-refresh (disabled - MCP endpoints removed)
    let mcpPollingEnabled = false;
    let lastStateHash = null;
    let currentImageUrl = null;

    // Update filename display in toolbar and right panel header
    async function updateFilenameDisplay(url) {
        const toolbarEl = document.getElementById('toolbarFilename');
        const headerEl = document.getElementById('currentFilename');

        if (!url) {
            const defaultText = 'No image loaded';
            if (toolbarEl) {
                toolbarEl.textContent = defaultText;
                toolbarEl.title = defaultText;
            }
            if (headerEl) {
                headerEl.textContent = defaultText;
                headerEl.title = defaultText;
            }
            return;
        }

        // Fetch the real filename from the API (not from URL which contains GUID)
        let filename = 'Image loaded';
        try {
            const response = await fetch('/api/current-image');
            const data = await response.json();
            if (data.filename) {
                filename = data.filename;
            }
        } catch (e) {
            // Fallback to URL parsing if API fails
            try {
                const urlPath = decodeURIComponent(url);
                filename = urlPath.split('/').pop().split('?')[0];
            } catch (e2) {
                // Keep default
            }
        }

        if (toolbarEl) {
            toolbarEl.textContent = filename;
            toolbarEl.title = filename;
        }
        if (headerEl) {
            headerEl.textContent = filename;
            headerEl.title = filename;
        }
    }

    function computeStateHash(state) {
        // Simple hash based on counts and image filename
        const tubCount = (state.tubercles || []).length;
        const edgeCount = (state.edges || []).length;
        const debugCount = (state.debug_shapes || []).length;
        const imgName = state.image?.filename || '';
        return `${imgName}:${tubCount}:${edgeCount}:${debugCount}`;
    }

    async function pollMCPState() {
        if (!mcpPollingEnabled) return;

        try {
            const response = await fetch('/api/tools/state');
            const state = await response.json();
            const newHash = computeStateHash(state);

            // Check if state changed
            if (newHash !== lastStateHash) {
                console.log('MCP state changed:', lastStateHash, '->', newHash);
                lastStateHash = newHash;

                // Load image if changed or not loaded
                if (state.image?.loaded && state.image?.filename) {
                    const imgResponse = await fetch('/api/current-image');
                    const imgData = await imgResponse.json();

                    if (imgData.web_url && imgData.web_url !== currentImageUrl) {
                        currentImageUrl = imgData.web_url;
                        await updateFilenameDisplay(currentImageUrl);
                        window.imageViewer.loadImage(currentImageUrl);
                        // Wait for image to load before setting overlay
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    // Update overlay data (including debug shapes)
                    window.overlay.setData(state.tubercles || [], state.edges || [], state.debug_shapes || []);

                    // Update calibration
                    if (state.calibration?.um_per_px) {
                        window.calibration?.setCalibration(state.calibration.um_per_px, state.calibration.method || 'mcp');
                    }

                    // Fetch and update statistics (computed on-the-fly)
                    try {
                        const statsResponse = await fetch('/api/tools/statistics');
                        const stats = await statsResponse.json();
                        updateStatisticsDisplay(stats);
                    } catch (e) {
                        console.log('Failed to fetch statistics:', e);
                    }

                    // Refresh data panel
                    window.dataPanel?.refresh();
                }
            }
        } catch (e) {
            // Silently ignore polling errors
        }

        // Schedule next poll (2 seconds)
        setTimeout(pollMCPState, 2000);
    }

    function updateStatisticsDisplay(stats) {
        // Update the statistics panel elements
        const panelElements = {
            'statNTubercles': stats.n_tubercles,
            'statNEdges': stats.n_edges,
            'statMeanDiameter': stats.mean_diameter_um?.toFixed(2),
            'statMeanSpace': stats.mean_space_um?.toFixed(2),
            'statGenus': stats.suggested_genus,
            'statConfidence': stats.classification_confidence,
            // Hexagonalness formula components
            'statSpacingUniformity': stats.spacing_uniformity?.toFixed(3),
            'statDegreeScore': stats.degree_score?.toFixed(3),
            'statEdgeRatioScore': stats.edge_ratio_score?.toFixed(3),
            // Supporting metrics
            'statSpacingCV': stats.spacing_cv?.toFixed(3),
            'statMeanDegree': stats.mean_degree?.toFixed(2),
        };

        // Update the stats bar elements
        const barElements = {
            'statsBarTubercles': stats.n_tubercles,
            'statsBarEdges': stats.n_edges,
            'statsBarDiameter': stats.mean_diameter_um?.toFixed(2),
            'statsBarSpace': stats.mean_space_um?.toFixed(2),
        };

        for (const [id, value] of Object.entries({...panelElements, ...barElements})) {
            const el = document.getElementById(id);
            if (el && value !== undefined) {
                el.textContent = value ?? '-';
            }
        }

        // Update hex score in stats bar
        const statsBarHex = document.getElementById('statsBarHex');
        if (statsBarHex) {
            const hexScore = stats.hexagonalness_score;
            const reliability = stats.reliability;
            if (hexScore !== undefined && reliability !== 'none') {
                statsBarHex.textContent = hexScore.toFixed(3);
                statsBarHex.classList.toggle('hex-low', reliability === 'low');
            } else {
                statsBarHex.textContent = '-';
                statsBarHex.classList.remove('hex-low');
            }
        }

        // Special handling for hexagonalness score (color-coded)
        const hexScoreEl = document.getElementById('statHexScore');
        const hexReliabilityEl = document.getElementById('statHexReliability');
        if (hexScoreEl) {
            const hexScore = stats.hexagonalness_score;
            const reliability = stats.reliability;
            if (hexScore !== undefined) {
                hexScoreEl.textContent = hexScore.toFixed(3);
                hexScoreEl.classList.remove('score-good', 'score-medium', 'score-poor');
                if (hexScore >= 0.7) {
                    hexScoreEl.classList.add('score-good');
                } else if (hexScore >= 0.4) {
                    hexScoreEl.classList.add('score-medium');
                } else {
                    hexScoreEl.classList.add('score-poor');
                }
            } else {
                hexScoreEl.textContent = '-';
                hexScoreEl.classList.remove('score-good', 'score-medium', 'score-poor');
            }

            // Show reliability indicator
            if (hexReliabilityEl) {
                hexReliabilityEl.classList.remove('reliability-high', 'reliability-low', 'reliability-none');
                if (reliability === 'low') {
                    hexReliabilityEl.textContent = `(${stats.n_nodes || 0} nodes - low confidence)`;
                    hexReliabilityEl.classList.add('reliability-low');
                } else if (reliability === 'none') {
                    hexReliabilityEl.textContent = '(insufficient data)';
                    hexReliabilityEl.classList.add('reliability-none');
                } else {
                    hexReliabilityEl.textContent = '';
                }
            }
        }
    }

    // Initialize workspace when DOM is ready
    document.addEventListener('DOMContentLoaded', async function() {
        // Get image URL from query params
        const params = new URLSearchParams(window.location.search);
        let imgUrl = params.get('img');

        // If no URL param and MCP is enabled, check if MCP API has loaded an image
        if (!imgUrl && mcpPollingEnabled) {
            try {
                const response = await fetch('/api/tools/state');
                const state = await response.json();
                lastStateHash = computeStateHash(state);

                if (state.image && state.image.loaded && state.image.filename) {
                    // Get the web path from current-image endpoint
                    const imgResponse = await fetch('/api/current-image');
                    const imgData = await imgResponse.json();
                    if (imgData.web_url) {
                        imgUrl = imgData.web_url;
                        currentImageUrl = imgUrl;
                        await updateFilenameDisplay(currentImageUrl);
                        // Also load any existing extraction data
                        if (state.tubercles && state.tubercles.length > 0) {
                            // Wait for image to load, then set overlay data
                            window.imageViewer.loadImage(imgUrl);
                            setTimeout(async () => {
                                window.overlay.setData(state.tubercles, state.edges || []);
                                if (state.calibration) {
                                    window.calibration.setCalibration(state.calibration.um_per_px, state.calibration.method || 'mcp');
                                }
                                // Fetch statistics (computed on-the-fly)
                                try {
                                    const statsResponse = await fetch('/api/tools/statistics');
                                    const stats = await statsResponse.json();
                                    updateStatisticsDisplay(stats);
                                } catch (e) {
                                    console.log('Failed to fetch statistics:', e);
                                }
                                window.dataPanel?.refresh();
                            }, 500);
                            window.app.loadLog();
                            // Start polling for MCP changes
                            setTimeout(pollMCPState, 2000);
                            return;
                        }
                    }
                }
            } catch (e) {
                console.log('No MCP state available:', e);
            }
        }

        if (imgUrl) {
            currentImageUrl = imgUrl;
            await updateFilenameDisplay(currentImageUrl);
            window.imageViewer.loadImage(imgUrl);
        }

        // Load initial log
        window.app.loadLog();

        // Start polling for MCP changes only if enabled
        if (mcpPollingEnabled) {
            setTimeout(pollMCPState, 2000);
        }
    });
</script>
{% endblock %}
